å
G/home/cossi/Code/UniShare/Backend/UniShare/RealTime/NotificationsHub.cs
	namespace 	
UniShare
 
. 
RealTime 
; 
public 
class 
NotificationsHub 
: 
Hub  #
<# $ 
INotificationsClient$ 8
>8 9
{		 
}

 “
K/home/cossi/Code/UniShare/Backend/UniShare/RealTime/INotificationsClient.cs
	namespace 	
UniShare
 
. 
RealTime 
; 
public 
	interface  
INotificationsClient %
{ 
Task 
NewItemAdded	 
( 
object 
item !
)! "
;" #
Task 
NewReviewAdded	 
( 
object 
review %
)% &
;& '
}		 ƒW
5/home/cossi/Code/UniShare/Backend/UniShare/Program.cs
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
builder 
. 
Services 
. 
	Configure 
< 
	Microsoft $
.$ %

AspNetCore% /
./ 0
Http0 4
.4 5
Json5 9
.9 :
JsonOptions: E
>E F
(F G
optionsG N
=>O Q
{ 
options 
. 
SerializerOptions 
.  
PropertyNamingPolicy 2
=3 4
null5 9
;9 :
options 
. 
SerializerOptions 
. 
WriteIndented +
=, -
true. 2
;2 3
options 
. 
SerializerOptions 
. 

Converters (
.( )
Add) ,
(, -
new- 0
System1 7
.7 8
Text8 <
.< =
Json= A
.A B
SerializationB O
.O P#
JsonStringEnumConverterP g
(g h
)h i
)i j
;j k
} 
) 
; 
if 
( 
builder 
. 
Environment 
. 
IsEnvironment %
(% &
$str& /
)/ 0
)0 1
{ 
builder   
.   
Services   
.   
AddDbContext   !
<  ! "
UniShareContext  " 1
>  1 2
(  2 3
options  3 :
=>  ; =
options!! 
.!! 
UseInMemoryDatabase!! #
(!!# $
$str!!$ 4
)!!4 5
)!!5 6
;!!6 7
}"" 
else## 
{$$ 
var%% 
connectionString%% 
=%% 
builder%% "
.%%" #
Configuration%%# 0
.%%0 1
GetConnectionString%%1 D
(%%D E
$str%%E X
)%%X Y
;%%Y Z
if&& 
(&& 
!&& 	
string&&	 
.&& 
IsNullOrWhiteSpace&& "
(&&" #
connectionString&&# 3
)&&3 4
)&&4 5
{'' 
builder(( 
.(( 
Services(( 
.(( 
AddDbContext(( %
<((% &
UniShareContext((& 5
>((5 6
(((6 7
options((7 >
=>((? A
options)) 
.)) 
	UseNpgsql)) 
()) 
connectionString)) .
))). /
)** 	
;**	 

}++ 
else,, 
{-- 
builder.. 
... 
Services.. 
... 
AddDbContext.. %
<..% &
UniShareContext..& 5
>..5 6
(..6 7
options..7 >
=>..? A
options// 
.// 
	UseNpgsql// 
(// 
$str// *
)//* +
)00 	
;00	 

}11 
}22 
builder44 
.44 
Services44 
.44 
AddHealthChecks44  
(44  !
)44! "
;44" #
builder77 
.77 
Services77 
.77 "
AddHttpContextAccessor77 '
(77' (
)77( )
;77) *
builder88 
.88 
Services88 
.88 
	AddScoped88 
<88 
RegisterUserHandler88 .
>88. /
(88/ 0
)880 1
;881 2
builder99 
.99 
Services99 
.99 
	AddScoped99 
<99 
GetAllUsersHandler99 -
>99- .
(99. /
)99/ 0
;990 1
builder:: 
.:: 
Services:: 
.:: 
	AddScoped:: 
<:: 

IValidator:: %
<::% &
RegisterUserRequest::& 9
>::9 :
,::: ;
CreateUserValidator::< O
>::O P
(::P Q
)::Q R
;::R S
builder;; 
.;; 
Services;; 
.;; 
	AddScoped;; 
<;; 
CreateItemHandler;; ,
>;;, -
(;;- .
);;. /
;;;/ 0
builder<< 
.<< 
Services<< 
.<< 
	AddScoped<< 
<<< 
DeleteItemHandler<< ,
><<, -
(<<- .
)<<. /
;<</ 0
builder== 
.== 
Services== 
.== 
	AddScoped== 
<== 
CreateReviewHandler== .
>==. /
(==/ 0
)==0 1
;==1 2
builder>> 
.>> 
Services>> 
.>> 
	AddScoped>> 
<>> 
LoginHandler>> '
>>>' (
(>>( )
)>>) *
;>>* +
builder?? 
.?? 
Services?? 
.?? 
	AddScoped?? 
<?? 

IValidator?? %
<??% &
CreateItemRequest??& 7
>??7 8
,??8 9
CreateItemValidator??: M
>??M N
(??N O
)??O P
;??P Q
builder@@ 
.@@ 
Services@@ 
.@@ 
	AddScoped@@ 
<@@ 

IValidator@@ %
<@@% &
CreateReviewRequest@@& 9
>@@9 :
,@@: ;!
CreateReviewValidator@@< Q
>@@Q R
(@@R S
)@@S T
;@@T U
builderAA 
.AA 
ServicesAA 
.AA 
	AddScopedAA 
<AA 

IValidatorAA %
<AA% &
LoginRequestAA& 2
>AA2 3
,AA3 4!
LoginRequestValidatorAA5 J
>AAJ K
(AAK L
)AAL M
;AAM N
builderBB 
.BB 
ServicesBB 
.BB 
	AddScopedBB 
<BB  
CreateBookingHandlerBB /
>BB/ 0
(BB0 1
)BB1 2
;BB2 3
builderCC 
.CC 
ServicesCC 
.CC 
	AddScopedCC 
<CC !
ApproveBookingHandlerCC 0
>CC0 1
(CC1 2
)CC2 3
;CC3 4
builderDD 
.DD 
ServicesDD 
.DD 
	AddScopedDD 
<DD "
CompleteBookingHandlerDD 1
>DD1 2
(DD2 3
)DD3 4
;DD4 5
builderEE 
.EE 
ServicesEE 
.EE 
	AddScopedEE 
<EE 

IValidatorEE %
<EE% & 
CreateBookingRequestEE& :
>EE: ;
,EE; <"
CreateBookingValidatorEE= S
>EES T
(EET U
)EEU V
;EEV W
builderFF 
.FF 
ServicesFF 
.FF 
	AddScopedFF 
<FF 

IValidatorFF %
<FF% &!
ApproveBookingRequestFF& ;
>FF; <
,FF< =#
ApproveBookingValidatorFF> U
>FFU V
(FFV W
)FFW X
;FFX Y
builderGG 
.GG 
ServicesGG 
.GG 

AddMediatRGG 
(GG 
cfgGG 
=>GG  "
cfgGG# &
.GG& '2
&RegisterServicesFromAssemblyContainingGG' M
<GGM N
ProgramGGN U
>GGU V
(GGV W
)GGW X
)GGX Y
;GGY Z
builderHH 
.HH 
ServicesHH 
.HH 

AddSignalRHH 
(HH 
)HH 
;HH 
builderLL 
.LL 
ServicesLL 
.LL 
AddCorsLL 
(LL 
optionsLL  
=>LL! #
{MM 
optionsNN 
.NN 
	AddPolicyNN 
(NN 
nameNN 
:NN 
$strNN +
,NN+ ,
policyOO 
=>OO 
{PP 	
policyQQ 
.QQ 
WithOriginsQQ 
(QQ 
$strQQ 6
,QQ6 7
$strQQ8 O
)QQO P
.RR 
AllowAnyHeaderRR !
(RR! "
)RR" #
.SS 
AllowAnyMethodSS !
(SS! "
)SS" #
.TT 
AllowCredentialsTT #
(TT# $
)TT$ %
;TT% &
}UU 	
)UU	 

;UU
 
}VV 
)VV 
;VV 
builderZZ 
.ZZ 
ServicesZZ 
.ZZ #
AddEndpointsApiExplorerZZ (
(ZZ( )
)ZZ) *
;ZZ* +
builder[[ 
.[[ 
Services[[ 
.[[ 
AddSwaggerGen[[ 
([[ 
)[[  
;[[  !
var]] 
app]] 
=]] 	
builder]]
 
.]] 
Build]] 
(]] 
)]] 
;]] 
if`` 
(`` 
!`` 
app`` 
.`` 	
Environment``	 
.`` 
IsEnvironment`` "
(``" #
$str``# ,
)``, -
)``- .
{aa 
usingbb 	
(bb
 
varbb 
scopebb 
=bb 
appbb 
.bb 
Servicesbb #
.bb# $
CreateScopebb$ /
(bb/ 0
)bb0 1
)bb1 2
{cc 
vardd 
ctxdd 
=dd 
scopedd 
.dd 
ServiceProviderdd '
.dd' (
GetRequiredServicedd( :
<dd: ;
UniShareContextdd; J
>ddJ K
(ddK L
)ddL M
;ddM N
awaitee 
ctxee 
.ee 
Databaseee 
.ee 
MigrateAsyncee '
(ee' (
)ee( )
;ee) *
}ff 
}gg 
appjj 
.jj 

UseSwaggerjj 
(jj 
)jj 
;jj 
appkk 
.kk 
UseSwaggerUIkk 
(kk 
)kk 
;kk 
appnn 
.nn 
UseCorsnn 
(nn 
$strnn 
)nn 
;nn 
appqq 
.qq '
UseAuthenticationMiddlewareqq 
(qq  
)qq  !
;qq! "
appss 
.ss 
UseHttpsRedirectionss 
(ss 
)ss 
;ss 
appuu 
.uu 
MapItemEndpointsuu 
(uu 
)uu 
;uu 
appvv 
.vv 
MapUserEndpointsvv 
(vv 
)vv 
;vv 
appww 
.ww 
MapBookingEndpointsww 
(ww 
)ww 
;ww 
appxx 
.xx 
MapReviewEndpointsxx 
(xx 
)xx 
;xx 
appyy 
.yy 
MapHubyy 

<yy
 
NotificationsHubyy 
>yy 
(yy 
$stryy 1
)yy1 2
;yy2 3
await{{ 
app{{ 	
.{{	 

RunAsync{{
 
({{ 
){{ 
;{{ 
public}} 
partial}} 
class}} 
Program}} 
{}} 
}}}  Î

]/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Validators/LoginRequestValidator.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "

Validators" ,
;, -
public 
class !
LoginRequestValidator "
:# $
AbstractValidator% 6
<6 7
LoginRequest7 C
>C D
{ 
public 
!
LoginRequestValidator  
(  !
)! "
{		 
RuleFor

 
(

 
x

 
=>

 
x

 
.

 
Email

 
)

 
. 
NotNull 
( 
) 
. 
NotEmpty 
( 
) 
. 
EmailAddress 
( 
) 
. 
WithMessage 
( 
$str 5
)5 6
;6 7
RuleFor 
( 
x 
=> 
x 
. 
Password 
)  
. 
NotNull 
( 
) 
. 
NotEmpty 
( 
) 
. 
WithMessage 
( 
$str 0
)0 1
;1 2
} 
} ‚
[/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Validators/CreateUserValidator.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "

Validators" ,
;, -
public 
class 
CreateUserValidator  
:  !
AbstractValidator! 2
<2 3
RegisterUserRequest3 F
>F G
{ 
public 

CreateUserValidator 
( 
)  
{ 
RuleFor		 
(		 
x		 
=>		 
x		 
.		 
Fullname		 
)		 
.		  
NotNull		  '
(		' (
)		( )
.		) *
NotEmpty		* 2
(		2 3
)		3 4
.		4 5
MinimumLength		5 B
(		B C
$num		C D
)		D E
.		E F
WithMessage		F Q
(		Q R
$str			R €
)
		€ 
;
		 ‚
RuleFor

 
(

 
x

 
=>

 
x

 
.

 
Email

 
)

 
.

 
NotNull

 %
(

% &
)

& '
.

' (
NotEmpty

( 0
(

0 1
)

1 2
.

2 3
EmailAddress

3 ?
(

? @
)

@ A
.

A B
WithMessage

B M
(

M N
$str

N j
)

j k
;

k l
RuleFor 
( 
x 
=> 
x 
. 
Password 
)  
. 
NotNull 
( 
) 
. 
NotEmpty 
(  
)  !
.! "
WithMessage" -
(- .
$str. E
)E F
. 
MinimumLength 
( 
$num 
) 
. 
WithMessage )
() *
$str* X
)X Y
. 
Matches 
( 
$str 
) 
. 
WithMessage *
(* +
$str+ a
)a b
. 
Matches 
( 
$str 
) 
. 
WithMessage *
(* +
$str+ a
)a b
. 
Matches 
( 
$str 
) 
. 
WithMessage '
(' (
$str( S
)S T
. 
Matches 
( 
$str $
)$ %
.% &
WithMessage& 1
(1 2
$str2 i
)i j
;j k
} 
} ¶
]/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Validators/CreateReviewValidator.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "

Validators" ,
;, -
public 
class !
CreateReviewValidator "
:# $
AbstractValidator% 6
<6 7
CreateReviewRequest7 J
>J K
{ 
public 
!
CreateReviewValidator  
(  !
)! "
{		 
RuleFor

 
(

 
r

 
=>

 
r

 
.

 
	BookingId

  
)

  !
. 
NotEmpty 
( 
) 
. 
WithMessage #
(# $
$str$ <
)< =
;= >
RuleFor 
( 
r 
=> 
r 
. 

ReviewerId !
)! "
. 
NotEmpty 
( 
) 
. 
WithMessage #
(# $
$str$ =
)= >
;> ?
RuleFor 
( 
r 
=> 
r 
. 
ItemId 
) 
. 
NotEmpty 
( 
) 
. 
WithMessage #
(# $
$str$ 9
)9 :
;: ;
RuleFor 
( 
r 
=> 
r 
. 
Rating 
) 
. 
InclusiveBetween 
( 
$num 
,  
$num! "
)" #
.# $
WithMessage$ /
(/ 0
$str0 Q
)Q R
;R S
RuleFor 
( 
r 
=> 
r 
. 
Comment 
) 
. 
NotEmpty 
( 
) 
. 
WithMessage #
(# $
$str$ :
): ;
. 
MaximumLength 
( 
$num 
) 
.  
WithMessage  +
(+ ,
$str, U
)U V
;V W
RuleFor 
( 
r 
=> 
r 
. 
RevType 
) 
. 
NotNull 
( 
) 
. 
WithMessage "
(" #
$str# =
)= >
;> ?
} 
} Å
[/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Validators/CreateItemValidator.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "

Validators" ,
;, -
public 
class 
CreateItemValidator  
:! "
AbstractValidator# 4
<4 5
CreateItemRequest5 F
>F G
{ 
public 

CreateItemValidator 
( 
)  
{		 
RuleFor

 
(

 
x

 
=>

 
x

 
.

 
Title

 
)

 
.

 
NotEmpty

 &
(

& '
)

' (
.

( )
MinimumLength

) 6
(

6 7
$num

7 8
)

8 9
.

9 :
WithMessage

: E
(

E F
$str

F q
)

q r
;

r s
RuleFor 
( 
x 
=> 
x 
. 
Description "
)" #
.# $
NotEmpty$ ,
(, -
)- .
.. /
MinimumLength/ <
(< =
$num= >
)> ?
.? @
WithMessage@ K
(K L
$strL }
)} ~
;~ 
RuleFor 
( 
x 
=> 
x 
. 
Categ 
) 
. 
IsInEnum &
(& '
)' (
.( )
WithMessage) 4
(4 5
$str5 V
)V W
;W X
RuleFor 
( 
x 
=> 
x 
. 
Cond 
) 
. 
IsInEnum %
(% &
)& '
.' (
WithMessage( 3
(3 4
$str4 V
)V W
;W X
RuleFor 
( 
x 
=> 
x 
. 
	DailyRate  
)  !
.! "
GreaterThan" -
(- .
$num. /
)/ 0
.0 1
When1 5
(5 6
x6 7
=>8 :
x; <
.< =
	DailyRate= F
.F G
HasValueG O
)O P
.P Q
WithMessageQ \
(\ ]
$str	] ‚
)
‚ ƒ
;
ƒ „
RuleFor 
( 
x 
=> 
x 
. 
ImageUrl 
)  
.  !
NotEmpty! )
() *
)* +
.+ ,
WithMessage, 7
(7 8
$str8 O
)O P
;P Q
} 
} ¸
^/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Validators/CreateBookingValidator.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "

Validators" ,
;, -
public 
class "
CreateBookingValidator #
:$ %
AbstractValidator& 7
<7 8 
CreateBookingRequest8 L
>L M
{ 
public 
"
CreateBookingValidator !
(! "
)" #
{		 
RuleFor

 
(

 
x

 
=>

 
x

 
.

 
ItemId

 
)

 
. 
NotEmpty 
( 
) 
. 
WithMessage 
( 
$str .
). /
;/ 0
RuleFor 
( 
x 
=> 
x 
. 
	StartDate  
)  !
. 
Must 
( 
d 
=> 
d 
!= 
default #
)# $
. 
WithMessage 
( 
$str 1
)1 2
;2 3
RuleFor 
( 
x 
=> 
x 
. 
EndDate 
) 
. 
Must 
( 
d 
=> 
d 
!= 
default #
)# $
. 
WithMessage 
( 
$str /
)/ 0
;0 1
RuleFor 
( 
x 
=> 
x 
) 
. 
Must 
( 
x 
=> 
x 
. 
EndDate  
>! "
x# $
.$ %
	StartDate% .
). /
. 
WithMessage 
( 
$str ;
); <
. 
When 
( 
x 
=> 
x 
. 
	StartDate "
!=# %
default& -
&&. 0
x1 2
.2 3
EndDate3 :
!=; =
default> E
)E F
;F G
RuleFor 
( 
x 
=> 
x 
. 
	StartDate  
)  !
. 
Must 
( 
d 
=> 
d 
. 
Date 
>=  
DateTime! )
.) *
UtcNow* 0
.0 1
Date1 5
)5 6
. 
WithMessage 
( 
$str ;
); <
. 
When 
( 
x 
=> 
x 
. 
	StartDate "
!=# %
default& -
)- .
;. /
} 
}   æ
_/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Validators/ApproveBookingValidator.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "

Validators" ,
;, -
public 
class #
ApproveBookingValidator $
:% &
AbstractValidator' 8
<8 9!
ApproveBookingRequest9 N
>N O
{ 
public 
#
ApproveBookingValidator "
(" #
)# $
{		 
RuleFor

 
(

 
x

 
=>

 
x

 
.

 
	BookingId

  
)

  !
. 
NotEmpty 
( 
) 
. 
WithMessage 
( 
$str 1
)1 2
;2 3
} 
} ºy
X/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Persistence/UniShareContext.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Persistence" -
;- .
public		 
class		 
UniShareContext		 
(		 
DbContextOptions		 -
<		- .
UniShareContext		. =
>		= >
options		? F
)		F G
:		H I
	DbContext		J S
(		S T
options		T [
)		[ \
{

 
public 

DbSet 
< 
User 
> 
Users 
{ 
get "
;" #
set$ '
;' (
}) *
=+ ,
null- 1
!1 2
;2 3
public 

DbSet 
< 
Item 
> 
Items 
{ 
get "
;" #
set$ '
;' (
}) *
=+ ,
null- 1
!1 2
;2 3
public 

DbSet 
< 
Review 
> 
Reviews  
{! "
get# &
;& '
set( +
;+ ,
}- .
=/ 0
null1 5
!5 6
;6 7
public 

DbSet 
< 
Booking 
> 
Bookings "
{# $
get% (
;( )
set* -
;- .
}/ 0
=1 2
null3 7
!7 8
;8 9
	protected 
override 
void 
OnModelCreating +
(+ ,
ModelBuilder, 8
modelBuilder9 E
)E F
{ 
base 
. 
OnModelCreating 
( 
modelBuilder )
)) *
;* +
modelBuilder 
. 
Entity 
< 
User  
>  !
(! "
entity" (
=>) +
{ 	
entity 
. 
ToTable 
( 
$str "
)" #
;# $
entity 
. 
Property 
( 
e 
=>  
e! "
." #
Id# %
)% &
. 
HasColumnName 
( 
$str #
)# $
. 
HasColumnType 
( 
$str %
)% &
;& '
entity 
. 
Property 
( 
e 
=>  
e! "
." #
FullName# +
)+ ,
., -
HasColumnName- :
(: ;
$str; F
)F G
;G H
entity 
. 
Property 
( 
e 
=>  
e! "
." #
Email# (
)( )
.) *
HasColumnName* 7
(7 8
$str8 ?
)? @
;@ A
entity 
. 
Property 
( 
e 
=>  
e! "
." #
PasswordHash# /
)/ 0
.0 1
HasColumnName1 >
(> ?
$str? N
)N O
;O P
entity   
.   
Property   
(   
e   
=>    
e  ! "
.  " #
Role  # '
)  ' (
.  ( )
HasColumnName  ) 6
(  6 7
$str  7 =
)  = >
;  > ?
entity!! 
.!! 
Property!! 
(!! 
e!! 
=>!!  
e!!! "
.!!" #
	CreatedAt!!# ,
)!!, -
.!!- .
HasColumnName!!. ;
(!!; <
$str!!< H
)!!H I
;!!I J
}"" 	
)""	 

;""
 
modelBuilder$$ 
.$$ 
Entity$$ 
<$$ 
Item$$  
>$$  !
($$! "
entity$$" (
=>$$) +
{%% 	
entity&& 
.&& 
ToTable&& 
(&& 
$str&& "
)&&" #
;&&# $
entity'' 
.'' 
Property'' 
('' 
e'' 
=>''  
e''! "
.''" #
Id''# %
)''% &
.(( 
HasColumnName(( 
((( 
$str(( #
)((# $
.)) 
HasColumnType)) 
()) 
$str)) %
)))% &
;))& '
entity** 
.** 
Property** 
(** 
e** 
=>**  
e**! "
.**" #
OwnerId**# *
)*** +
.**+ ,
HasColumnName**, 9
(**9 :
$str**: D
)**D E
;**E F
entity++ 
.++ 
Property++ 
(++ 
e++ 
=>++  
e++! "
.++" #
Title++# (
)++( )
.++) *
HasColumnName++* 7
(++7 8
$str++8 ?
)++? @
;++@ A
entity,, 
.,, 
Property,, 
(,, 
e,, 
=>,,  
e,,! "
.,," #
Description,,# .
),,. /
.,,/ 0
HasColumnName,,0 =
(,,= >
$str,,> K
),,K L
;,,L M
entity-- 
.-- 
Property-- 
(-- 
e-- 
=>--  
e--! "
.--" #
Categ--# (
)--( )
... 
HasColumnName.. 
(.. 
$str.. )
)..) *
.// 
HasConversion// 
<// 
string// %
>//% &
(//& '
)//' (
;//( )
entity00 
.00 
Property00 
(00 
e00 
=>00  
e00! "
.00" #
Cond00# '
)00' (
.11 
HasColumnName11 
(11 
$str11 *
)11* +
.22 
HasConversion22 
<22 
string22 %
>22% &
(22& '
)22' (
;22( )
entity33 
.33 
Property33 
(33 
e33 
=>33  
e33! "
.33" #
	DailyRate33# ,
)33, -
.33- .
HasColumnName33. ;
(33; <
$str33< H
)33H I
;33I J
entity44 
.44 
Property44 
(44 
e44 
=>44  
e44! "
.44" #
ImageUrl44# +
)44+ ,
.44, -
HasColumnName44- :
(44: ;
$str44; F
)44F G
;44G H
entity55 
.55 
Property55 
(55 
e55 
=>55  
e55! "
.55" #
IsAvailable55# .
)55. /
.55/ 0
HasColumnName550 =
(55= >
$str55> L
)55L M
;55M N
entity66 
.66 
Property66 
(66 
e66 
=>66  
e66! "
.66" #
	CreatedAt66# ,
)66, -
.66- .
HasColumnName66. ;
(66; <
$str66< H
)66H I
;66I J
}77 	
)77	 

;77
 
modelBuilder99 
.99 
Entity99 
<99 
Booking99 #
>99# $
(99$ %
entity99% +
=>99, .
{:: 	
entity;; 
.;; 
ToTable;; 
(;; 
$str;; %
);;% &
;;;& '
entity== 
.== 
Property== 
(== 
e== 
=>==  
e==! "
.==" #
Id==# %
)==% &
.==& '
HasColumnName==' 4
(==4 5
$str==5 9
)==9 :
.==: ;
HasColumnType==; H
(==H I
$str==I O
)==O P
;==P Q
entity>> 
.>> 
Property>> 
(>> 
e>> 
=>>>  
e>>! "
.>>" #
ItemId>># )
)>>) *
.>>* +
HasColumnName>>+ 8
(>>8 9
$str>>9 B
)>>B C
;>>C D
entity?? 
.?? 
Property?? 
(?? 
e?? 
=>??  
e??! "
.??" #

BorrowerId??# -
)??- .
.??. /
HasColumnName??/ <
(??< =
$str??= J
)??J K
;??K L
entity@@ 
.@@ 
Property@@ 
(@@ 
e@@ 
=>@@  
e@@! "
.@@" #
OwnerId@@# *
)@@* +
.@@+ ,
HasColumnName@@, 9
(@@9 :
$str@@: D
)@@D E
;@@E F
entityBB 
.BB 
PropertyBB 
(BB 
eBB 
=>BB  
eBB! "
.BB" #
StatusBB# )
)BB) *
.CC 
HasColumnNameCC 
(CC 
$strCC '
)CC' (
.DD 
HasConversionDD 
<DD 
stringDD %
>DD% &
(DD& '
)DD' (
;DD( )
entityFF 
.FF 
PropertyFF 
(FF 
eFF 
=>FF  
eFF! "
.FF" #
	StartDateFF# ,
)FF, -
.FF- .
HasColumnNameFF. ;
(FF; <
$strFF< H
)FFH I
;FFI J
entityGG 
.GG 
PropertyGG 
(GG 
eGG 
=>GG  
eGG! "
.GG" #
EndDateGG# *
)GG* +
.GG+ ,
HasColumnNameGG, 9
(GG9 :
$strGG: D
)GGD E
;GGE F
entityHH 
.HH 
PropertyHH 
(HH 
eHH 
=>HH  
eHH! "
.HH" #
ActualReturnDateHH# 3
)HH3 4
.HH4 5
HasColumnNameHH5 B
(HHB C
$strHHC W
)HHW X
;HHX Y
entityII 
.II 
PropertyII 
(II 
eII 
=>II  
eII! "
.II" #

TotalPriceII# -
)II- .
.II. /
HasColumnNameII/ <
(II< =
$strII= J
)IIJ K
;IIK L
entityJJ 
.JJ 
PropertyJJ 
(JJ 
eJJ 
=>JJ  
eJJ! "
.JJ" #
RequestedAtJJ# .
)JJ. /
.JJ/ 0
HasColumnNameJJ0 =
(JJ= >
$strJJ> L
)JJL M
;JJM N
entityKK 
.KK 
PropertyKK 
(KK 
eKK 
=>KK  
eKK! "
.KK" #

ApprovedAtKK# -
)KK- .
.KK. /
HasColumnNameKK/ <
(KK< =
$strKK= J
)KKJ K
;KKK L
entityLL 
.LL 
PropertyLL 
(LL 
eLL 
=>LL  
eLL! "
.LL" #
CompletedAtLL# .
)LL. /
.LL/ 0
HasColumnNameLL0 =
(LL= >
$strLL> L
)LLL M
;LLM N
entityOO 
.OO 
HasOneOO 
<OO 
ItemOO 
>OO 
(OO  
)OO  !
.PP 
WithManyPP 
(PP 
)PP 
.QQ 
HasForeignKeyQQ 
(QQ 
eQQ  
=>QQ! #
eQQ$ %
.QQ% &
ItemIdQQ& ,
)QQ, -
.RR 
OnDeleteRR 
(RR 
DeleteBehaviorRR (
.RR( )
RestrictRR) 1
)RR1 2
;RR2 3
entityTT 
.TT 
HasOneTT 
<TT 
UserTT 
>TT 
(TT  
)TT  !
.UU 
WithManyUU 
(UU 
)UU 
.VV 
HasForeignKeyVV 
(VV 
eVV  
=>VV! #
eVV$ %
.VV% &

BorrowerIdVV& 0
)VV0 1
.WW 
OnDeleteWW 
(WW 
DeleteBehaviorWW (
.WW( )
RestrictWW) 1
)WW1 2
;WW2 3
entityYY 
.YY 
HasOneYY 
<YY 
UserYY 
>YY 
(YY  
)YY  !
.ZZ 
WithManyZZ 
(ZZ 
)ZZ 
.[[ 
HasForeignKey[[ 
([[ 
e[[  
=>[[! #
e[[$ %
.[[% &
OwnerId[[& -
)[[- .
.\\ 
OnDelete\\ 
(\\ 
DeleteBehavior\\ (
.\\( )
Restrict\\) 1
)\\1 2
;\\2 3
}]] 	
)]]	 

;]]
 
modelBuilder__ 
.__ 
Entity__ 
<__ 
Review__ "
>__" #
(__# $
entity__$ *
=>__+ -
{`` 	
entityaa 
.aa 
ToTableaa 
(aa 
$straa $
)aa$ %
;aa% &
entitybb 
.bb 
Propertybb 
(bb 
ebb 
=>bb  
ebb! "
.bb" #
Idbb# %
)bb% &
.cc 
HasColumnNamecc 
(cc 
$strcc #
)cc# $
.dd 
HasColumnTypedd 
(dd 
$strdd %
)dd% &
;dd& '
entityee 
.ee 
Propertyee 
(ee 
eee 
=>ee  
eee! "
.ee" #
	BookingIdee# ,
)ee, -
.ee- .
HasColumnNameee. ;
(ee; <
$stree< H
)eeH I
;eeI J
entityff 
.ff 
Propertyff 
(ff 
eff 
=>ff  
eff! "
.ff" #

ReviewerIdff# -
)ff- .
.ff. /
HasColumnNameff/ <
(ff< =
$strff= J
)ffJ K
;ffK L
entitygg 
.gg 
Propertygg 
(gg 
egg 
=>gg  
egg! "
.gg" #
ItemIdgg# )
)gg) *
.gg* +
HasColumnNamegg+ 8
(gg8 9
$strgg9 B
)ggB C
;ggC D
entityhh 
.hh 
Propertyhh 
(hh 
ehh 
=>hh  
ehh! "
.hh" #
Ratinghh# )
)hh) *
.hh* +
HasColumnNamehh+ 8
(hh8 9
$strhh9 A
)hhA B
;hhB C
entityii 
.ii 
Propertyii 
(ii 
eii 
=>ii  
eii! "
.ii" #
Commentii# *
)ii* +
.ii+ ,
HasColumnNameii, 9
(ii9 :
$strii: C
)iiC D
;iiD E
entityjj 
.jj 
Propertyjj 
(jj 
ejj 
=>jj  
ejj! "
.jj" #
RevTypejj# *
)jj* +
.kk 
HasColumnNamekk 
(kk 
$strkk ,
)kk, -
.ll 
HasConversionll 
<ll 
intll "
>ll" #
(ll# $
)ll$ %
;ll% &
entitymm 
.mm 
Propertymm 
(mm 
emm 
=>mm  
emm! "
.mm" #
	CreatedAtmm# ,
)mm, -
.mm- .
HasColumnNamemm. ;
(mm; <
$strmm< H
)mmH I
;mmI J
}nn 	
)nn	 

;nn
 
}oo 
}pp ¤
P/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Users/User.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Users+ 0
;0 1
public 
enum 
Role 
{ 
Admin 	
,	 

User 
} 
public		 
record		 
User		 
(		 
Guid		 
Id		 
,		 
string		 "
FullName		# +
,		+ ,
string		- 3
Email		4 9
,		9 :
string		; A
PasswordHash		B N
,		N O
Role		P T
Role		U Y
,		Y Z
DateTime		[ c
	CreatedAt		d m
)		m n
;		n oÈ
h/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Users/Register/RegisterUserRequest.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Users+ 0
.0 1
Register1 9
;9 :
public 
record 
RegisterUserRequest !
(! "
string" (
Fullname) 1
,1 2
string3 9
Email: ?
,? @
stringA G
PasswordH P
)P Q
;Q Rí 
h/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Users/Register/RegisterUserHandler.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Users+ 0
.0 1
Register1 9
;9 :
public		 
class		 
RegisterUserHandler		  
(		  !
UniShareContext		! 0
context		1 8
,		8 9

IValidator		: D
<		D E
RegisterUserRequest		E X
>		X Y
	validator		Z c
)		c d
{

 
public 

async 
Task 
< 
IResult 
> 
Handle %
(% &
RegisterUserRequest& 9
request: A
)A B
{ 
ValidationResult 
validationResult )
=* +
await, 1
	validator2 ;
.; <
ValidateAsync< I
(I J
requestJ Q
)Q R
;R S
if 

( 
! 
validationResult 
. 
IsValid %
)% &
{ 	
Log 
. 
Error 
( 
$str A
)A B
;B C
return 
Results 
. 
ValidationProblem ,
(, -
validationResult- =
.= >
ToDictionary> J
(J K
)K L
)L M
;M N
} 	
var 
existingUser 
= 
await  
context! (
.( )
Users) .
.. /
FirstOrDefaultAsync/ B
(B C
uC D
=>E G
uH I
.I J
EmailJ O
==P R
requestS Z
.Z [
Email[ `
)` a
;a b
if 

( 
existingUser 
is 
not 
null  $
)$ %
{ 	
Log 
. 
Error 
( 
$" 
$str )
{) *
request* 1
.1 2
Email2 7
}7 8
$str8 G
"G H
)H I
;I J
return 
Results 
. 
Problem "
(" #
$str# K
,K L

statusCodeM W
:W X
$numY \
)\ ]
;] ^
} 	
var 
passwordHash 
= 
BCrypt !
.! "
Net" %
.% &
BCrypt& ,
., -
HashPassword- 9
(9 :
request: A
.A B
PasswordB J
)J K
;K L
var 
user 
= 
new 
User 
( 
Guid  
.  !
NewGuid! (
(( )
)) *
,* +
request, 3
.3 4
Fullname4 <
,< =
request> E
.E F
EmailF K
,K L
passwordHashM Y
,Y Z
Role[ _
._ `
User` d
,d e
DateTimef n
.n o
UtcNowo u
)u v
;v w
context 
. 
Users 
. 
Add 
( 
user 
) 
;  
await   
context   
.   
SaveChangesAsync   &
(  & '
)  ' (
;  ( )
Log!! 
.!! 
Info!! 
(!! 
$"!! 
$str!! !
{!!! "
user!!" &
.!!& '
Id!!' )
}!!) *
$str!!* 9
"!!9 :
)!!: ;
;!!; <
return"" 
Results"" 
."" 
Created"" 
("" 
$""" !
$str""! (
{""( )
user"") -
.""- .
Id"". 0
}""0 1
"""1 2
,""2 3
user""4 8
)""8 9
;""9 :
}## 
}$$ ×
Y/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Users/Login/UserDto.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Users+ 0
.0 1
Login1 6
;6 7
public 
record 
UserDto 
( 
Guid 
Id 
, 
string %
FullName& .
,. /
string0 6
Email7 <
,< =
string> D
RoleE I
)I J
;J Kú
_/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Users/Login/LoginResponse.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Users+ 0
.0 1
Login1 6
;6 7
public 
record 
LoginResponse 
( 
string "
Token# (
,( )
UserDto* 1
User2 6
)6 7
;7 8û
^/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Users/Login/LoginRequest.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Users+ 0
.0 1
Login1 6
;6 7
public 
record 
LoginRequest 
( 
string !
Email" '
,' (
string) /
Password0 8
)8 9
;9 :ü"
^/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Users/Login/LoginHandler.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Users+ 0
.0 1
Login1 6
;6 7
public 
class 
LoginHandler 
( 
UniShareContext 
context 
, 

IValidator		 
<		 
LoginRequest		 
>		 
	validator		 &
)		& '
{

 
public 

async 
Task 
< 
IResult 
> 
Handle %
(% &
LoginRequest& 2
request3 :
): ;
{ 
var 
validationResult 
= 
await $
	validator% .
.. /
ValidateAsync/ <
(< =
request= D
)D E
;E F
if 

( 
! 
validationResult 
. 
IsValid %
)% &
{ 	
var 
errors 
= 
validationResult )
.) *
Errors* 0
. 
GroupBy 
( 
e 
=> 
e 
.  
PropertyName  ,
), -
. 
ToDictionary 
( 
g 
=> 
g 
. 
Key 
, 
g 
=> 
g 
. 
Select !
(! "
e" #
=>$ &
e' (
.( )
ErrorMessage) 5
)5 6
.6 7
ToArray7 >
(> ?
)? @
) 
; 
Log 
. 
Error 
( 
$str :
): ;
;; <
return 
Results 
. 
ValidationProblem ,
(, -
errors- 3
)3 4
;4 5
} 	
var 
user 
= 
await 
context  
.  !
Users! &
. 
FirstOrDefaultAsync  
(  !
u! "
=># %
u& '
.' (
Email( -
==. 0
request1 8
.8 9
Email9 >
)> ?
;? @
if 

( 
user 
is 
null 
|| 
! 
BCrypt #
.# $
Net$ '
.' (
BCrypt( .
.. /
Verify/ 5
(5 6
request6 =
.= >
Password> F
,F G
userH L
.L M
PasswordHashM Y
)Y Z
)Z [
{ 	
Log   
.   
Error   
(   
$"   
$str   A
{  A B
request  B I
.  I J
Email  J O
}  O P
"  P Q
)  Q R
;  R S
return!! 
Results!! 
.!! 
Unauthorized!! '
(!!' (
)!!( )
;!!) *
}"" 	
var$$ 
token$$ 
=$$ 
$"$$ 
$str$$ !
{$$! "
user$$" &
.$$& '
Id$$' )
}$$) *
"$$* +
;$$+ ,
var&& 
userDto&& 
=&& 
new&& 
UserDto&& !
(&&! "
user&&" &
.&&& '
Id&&' )
,&&) *
user&&+ /
.&&/ 0
FullName&&0 8
,&&8 9
user&&: >
.&&> ?
Email&&? D
,&&D E
user&&F J
.&&J K
Role&&K O
.&&O P
ToString&&P X
(&&X Y
)&&Y Z
)&&Z [
;&&[ \
Log'' 
.'' 
Info'' 
('' 
$"'' 
$str'' !
{''! "
user''" &
.''& '
Id''' )
}'') *
$str''* 4
"''4 5
)''5 6
;''6 7
return(( 
Results(( 
.(( 
Ok(( 
((( 
new(( 
LoginResponse(( +
(((+ ,
token((, 1
,((1 2
userDto((3 :
)((: ;
)((; <
;((< =
})) 
}** ì
e/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Users/GetAll/GetAllUsersHandler.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Users+ 0
.0 1
GetAll1 7
;7 8
public 
class 
GetAllUsersHandler 
(  
UniShareContext  /
context0 7
)7 8
{ 
public		 

async		 
Task		 
<		 
IResult		 
>		 
Handle		 %
(		% &
)		& '
{

 
var 
users 
= 
await 
context !
.! "
Users" '
.' (
ToListAsync( 3
(3 4
)4 5
;5 6
Log 
. 
Info 
( 
$str +
)+ ,
;, -
return 
Results 
. 
Ok 
( 
users 
)  
;  !
} 
} î
T/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Reviews/Review.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Reviews+ 2
;2 3
public 
enum 

ReviewType 
{ 
Bad 
= 	
$num
 
, 
Ok 
= 
$num	 

,
 
Good 
=	 

$num 
, 
VeryGood 
= 
$num 
}		 
public 
record 
Review 
( 
Guid 
Id 
, 
Guid "
	BookingId# ,
,, -
Guid. 2

ReviewerId3 =
,= >
Guid? C
ItemIdD J
,J K
intL O
RatingP V
,V W
stringX ^
Comment_ f
,f g

ReviewTypeh r
RevTypes z
,z {
DateTime	| „
	CreatedAt
… Ž
)
Ž 
;
 Õ
i/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Reviews/GetAll/GetAllReviewsRequest.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Reviews+ 2
.2 3
GetAll3 9
;9 :
public 
record  
GetAllReviewsRequest "
(" #
Guid# '
Item( ,
), -
;- .
i/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Reviews/GetAll/GetAllReviewsHandler.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Reviews+ 2
.2 3
GetAll3 9
;9 :
public 
static 
class 
GetAllReviews !
{		 
public

 

record

 
Query

 
:

 
IRequest

 "
<

" #
IEnumerable

# .
<

. /
Review

/ 5
>

5 6
>

6 7
;

7 8
public 

class 
Handler 
( 
UniShareContext (
context) 0
)0 1
:2 3
IRequestHandler4 C
<C D
QueryD I
,I J
IEnumerableK V
<V W
ReviewW ]
>] ^
>^ _
{ 
public 
async 
Task 
< 
IEnumerable %
<% &
Review& ,
>, -
>- .
Handle/ 5
(5 6
Query6 ;
request< C
,C D
CancellationTokenE V
cancellationTokenW h
)h i
{ 	
Log 
. 
Info 
( 
$str 1
)1 2
;2 3
return 
await 
context  
.  !
Reviews! (
.( )
ToListAsync) 4
(4 5
cancellationToken5 F
)F G
;G H
} 	
} 
} Œ
n/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Reviews/CreateReview/CreateReviewRequest.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Reviews+ 2
.2 3
CreateReview3 ?
;? @
public 
record 
CreateReviewRequest !
(! "
Guid" &
	BookingId' 0
,0 1
Guid2 6

ReviewerId7 A
,A B
GuidC G
ItemIdH N
,N O
intP S
RatingT Z
,Z [
string\ b
Commentc j
,j k

ReviewTypel v
?v w
RevTypex 
)	 €
;
€ ä8
n/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Reviews/CreateReview/CreateReviewHandler.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Reviews+ 2
.2 3
CreateReview3 ?
;? @
public		 
class		 
CreateReviewHandler		  
(		  !
UniShareContext

 
context

 
,

 

IValidator 
< 
CreateReviewRequest "
>" #
	validator$ -
,- . 
IHttpContextAccessor 
httpContextAccessor ,
), -
{ 
public 

async 
Task 
< 
IResult 
> 
Handle %
(% &
CreateReviewRequest& 9
request: A
)A B
{ 
var 
validationResult 
= 
await $
	validator% .
.. /
ValidateAsync/ <
(< =
request= D
)D E
;E F
if 

( 
! 
validationResult 
. 
IsValid %
)% &
{ 	
var 
errors 
= 
validationResult )
.) *
Errors* 0
. 
GroupBy 
( 
e 
=> 
e 
.  
PropertyName  ,
), -
. 
ToDictionary 
( 
g 
=>  "
g# $
.$ %
Key% (
,( )
g* +
=>, .
g/ 0
.0 1
Select1 7
(7 8
e8 9
=>: <
e= >
.> ?
ErrorMessage? K
)K L
.L M
ToArrayM T
(T U
)U V
)V W
;W X
Log 
. 
Error 
( 
$str A
)A B
;B C
return 
Results 
. 
ValidationProblem ,
(, -
errors- 3
)3 4
;4 5
} 	
var 
currentUserId 
= 
	GetUserId %
(% &
)& '
;' (
if 

( 
! 
currentUserId 
. 
HasValue #
)# $
return 
Results 
. 
Unauthorized '
(' (
)( )
;) *
var 
booking 
= 
await 
context #
.# $
Bookings$ ,
., -
AsNoTracking- 9
(9 :
): ;
.; <
FirstOrDefaultAsync< O
(O P
bP Q
=>R T
bU V
.V W
IdW Y
==Z \
request] d
.d e
	BookingIde n
)n o
;o p
if 

( 
booking 
is 
null 
) 
return   
Results   
.   

BadRequest   %
(  % &
new  & )
{  * +
error  , 1
=  2 3
$str  4 H
}  I J
)  J K
;  K L
if"" 

("" 
booking"" 
."" 

BorrowerId"" 
!="" !
currentUserId""" /
.""/ 0
Value""0 5
)""5 6
return## 
Results## 
.## 
Forbid## !
(##! "
)##" #
;### $
if%% 

(%% 
booking%% 
.%% 
Status%% 
!=%% 
Status%% $
.%%$ %
	Completed%%% .
)%%. /
return&& 
Results&& 
.&& 

BadRequest&& %
(&&% &
new&&& )
{&&* +
error&&, 1
=&&2 3
$str&&4 f
}&&g h
)&&h i
;&&i j
var(( 
existingReview(( 
=(( 
await(( "
context((# *
.((* +
Reviews((+ 2
.((2 3
AnyAsync((3 ;
(((; <
r((< =
=>((> @
r((A B
.((B C
	BookingId((C L
==((M O
request((P W
.((W X
	BookingId((X a
)((a b
;((b c
if)) 

()) 
existingReview)) 
))) 
return** 
Results** 
.** 
Conflict** #
(**# $
new**$ '
{**( )
error*** /
=**0 1
$str**2 ]
}**^ _
)**_ `
;**` a
var,, 
review,, 
=,, 
new,, 
Review,, 
(,,  
Guid-- 
.-- 
NewGuid-- 
(-- 
)-- 
,-- 
request.. 
... 
	BookingId.. 
,.. 
currentUserId// 
.// 
Value// 
,//  
booking00 
.00 
ItemId00 
,00 
request11 
.11 
Rating11 
,11 
request22 
.22 
Comment22 
,22 
request33 
.33 
RevType33 
!33 
.33 
Value33 "
,33" #
DateTime44 
.44 
UtcNow44 
)55 	
;55	 

context77 
.77 
Reviews77 
.77 
Add77 
(77 
review77 "
)77" #
;77# $
await88 
context88 
.88 
SaveChangesAsync88 &
(88& '
)88' (
;88( )
Log:: 
.:: 
Info:: 
(:: 
$":: 
$str:: #
{::# $
review::$ *
.::* +
Id::+ -
}::- .
$str::. :
"::: ;
)::; <
;::< =
return;; 
Results;; 
.;; 
Created;; 
(;; 
$";; !
$str;;! *
{;;* +
review;;+ 1
.;;1 2
Id;;2 4
};;4 5
";;5 6
,;;6 7
review;;8 >
);;> ?
;;;? @
}<< 
private>> 
Guid>> 
?>> 
	GetUserId>> 
(>> 
)>> 
{?? 
var@@ 
ctx@@ 
=@@ 
httpContextAccessor@@ %
.@@% &
HttpContext@@& 1
;@@1 2
ifAA 

(AA 
ctxAA 
?AA 
.AA 
ItemsAA 
isAA 
nullAA 
||AA !
!AA" #
ctxAA# &
.AA& '
ItemsAA' ,
.AA, -
TryGetValueAA- 8
(AA8 9
$strAA9 A
,AAA B
outAAC F
varAAG J
	userIdObjAAK T
)AAT U
)AAU V
{BB 	
returnCC 
nullCC 
;CC 
}DD 	
returnEE 
	userIdObjEE 
asEE 
GuidEE  
?EE  !
;EE! "
}FF 
}GG Á
P/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Items/Item.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Items+ 0
;0 1
public 
enum 
Category 
{ 
Books 	
=
 
$num 
, 
Electronics 
= 
$num 
, 
Clothing 
= 
$num 
, 
	Furniture 
= 
$num 
, 
Sports		 

=		 
$num		 
,		 
Other

 	
=


 
$num

 
} 
public 
enum 
	Condition 
{ 
New 
= 	
$num
 
, 
LikeNew 
= 
$num 
, 
WellPreserved 
= 
$num 
, 

Acceptable 
= 
$num 
, 
Poor 
=	 

$num 
} 
public 
record 
Item 
( 
Guid 
Id 
, 
Guid  
OwnerId! (
,( )
string* 0
Title1 6
,6 7
string8 >
Description? J
,J K
CategoryL T
CategU Z
,Z [
	Condition\ e
Condf j
,j k
decimall s
?s t
	DailyRateu ~
,~ 
string
€ †
?
† ‡
ImageUrl
ˆ 
,
 ‘
bool
’ –
IsAvailable
— ¢
,
¢ £
DateTime
¤ ¬
	CreatedAt
­ ¶
)
¶ ·
;
· ¸Ï
e/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Items/GetAll/GetAllItemsRequest.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Items+ 0
.0 1
GetAll1 7
;7 8
public 
class 
GetAllItemsRequest 
(  
Guid  $
OwnerId% ,
), -
;- .Ñ
m/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Items/GetByOwner/GetItemsByOwnerHandler.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Items+ 0
.0 1

GetByOwner1 ;
;; <
public		 
static		 
class		 
GetItemsByOwner		 #
{

 
public 

record 
Query 
( 
Guid 
OwnerId $
)$ %
:& '
IRequest( 0
<0 1
IEnumerable1 <
<< =
Item= A
>A B
>B C
;C D
public 

class 
Handler 
( 
UniShareContext (
context) 0
)0 1
:2 3
IRequestHandler4 C
<C D
QueryD I
,I J
IEnumerableK V
<V W
ItemW [
>[ \
>\ ]
{ 
public 
async 
Task 
< 
IEnumerable %
<% &
Item& *
>* +
>+ ,
Handle- 3
(3 4
Query4 9
request: A
,A B
CancellationTokenC T
cancellationTokenU f
)f g
{ 	
Log 
. 
Info 
( 
$" 
$str 1
{1 2
request2 9
.9 :
OwnerId: A
}A B
"B C
)C D
;D E
return 
await 
context  
.  !
Items! &
. 
Where 
( 
item 
=> 
item #
.# $
OwnerId$ +
==, .
request/ 6
.6 7
OwnerId7 >
)> ?
. 
OrderByDescending "
(" #
item# '
=>( *
item+ /
./ 0
	CreatedAt0 9
)9 :
. 
ToListAsync 
( 
cancellationToken .
). /
;/ 0
} 	
} 
} ÿ
e/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Items/GetAll/GetAllItemsHandler.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Items+ 0
.0 1
GetAll1 7
;7 8
public 
static 
class 
GetAllItems 
{		 
public

 

record

 
Query

 
:

 
IRequest

 "
<

" #
IEnumerable

# .
<

. /
Item

/ 3
>

3 4
>

4 5
;

5 6
public 

class 
Handler 
( 
UniShareContext (
context) 0
)0 1
:2 3
IRequestHandler4 C
<C D
QueryD I
,I J
IEnumerableK V
<V W
ItemW [
>[ \
>\ ]
{ 
public 
async 
Task 
< 
IEnumerable %
<% &
Item& *
>* +
>+ ,
Handle- 3
(3 4
Query4 9
request: A
,A B
CancellationTokenC T
cancellationTokenU f
)f g
{ 	
Log 
. 
Info 
( 
$str /
)/ 0
;0 1
return 
await 
context  
.  !
Items! &
.& '
ToListAsync' 2
(2 3
cancellationToken3 D
)D E
;E F
} 	
} 
} é%
d/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Items/Delete/DeleteItemHandler.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Items+ 0
.0 1
Delete1 7
;7 8
public

 
class

 
DeleteItemHandler

 
(

 
UniShareContext 
context 
,  
IHttpContextAccessor 
httpContextAccessor ,
), -
{ 
public 

async 
Task 
< 
IResult 
> 
Handle %
(% &
Guid& *
itemId+ 1
)1 2
{ 
var 
httpContext 
= 
httpContextAccessor -
.- .
HttpContext. 9
;9 :
if 

( 
httpContext 
is 
null 
)  
{ 	
Log 
. 
Error 
( 
$str >
)> ?
;? @
return 
Results 
. 
Unauthorized '
(' (
)( )
;) *
} 	
httpContext 
. 
Items 
. 
TryGetValue %
(% &
$str& .
,. /
out0 3
var4 7
	userIdObj8 A
)A B
;B C
if 

( 
	userIdObj 
is 
not 
Guid !
userId" (
)( )
{ 	
Log 
. 
Error 
( 
$str Q
)Q R
;R S
return 
Results 
. 
Unauthorized '
(' (
)( )
;) *
} 	
var 
item 
= 
await 
context  
.  !
Items! &
.& '
FirstOrDefaultAsync' :
(: ;
i; <
=>= ?
i@ A
.A B
IdB D
==E G
itemIdH N
)N O
;O P
if 

( 
item 
is 
null 
) 
{   	
Log!! 
.!! 
Error!! 
(!! 
$"!! 
$str!! 0
{!!0 1
itemId!!1 7
}!!7 8
$str!!8 B
"!!B C
)!!C D
;!!D E
return"" 
Results"" 
."" 
NotFound"" #
(""# $
)""$ %
;""% &
}## 	
if%% 

(%% 
item%% 
.%% 
OwnerId%% 
!=%% 
userId%% "
)%%" #
{&& 	
Log'' 
.'' 
Error'' 
('' 
$"'' 
$str'' 0
{''0 1
userId''1 7
}''7 8
$str''8 N
{''N O
itemId''O U
}''U V
"''V W
)''W X
;''X Y
return(( 
Results(( 
.(( 
Forbid(( !
(((! "
)((" #
;((# $
})) 	
var,, 
hasBookings,, 
=,, 
await,, 
context,,  '
.,,' (
Bookings,,( 0
.,,0 1
AnyAsync,,1 9
(,,9 :
b,,: ;
=>,,< >
b,,? @
.,,@ A
ItemId,,A G
==,,H J
itemId,,K Q
),,Q R
;,,R S
if-- 

(-- 
hasBookings-- 
)-- 
{.. 	
Log// 
.// 
Error// 
(// 
$"// 
$str// 0
{//0 1
itemId//1 7
}//7 8
$str//8 M
"//M N
)//N O
;//O P
return00 
Results00 
.00 
Conflict00 #
(00# $
new00$ '
{00( )
message00* 1
=002 3
$str004 j
}00k l
)00l m
;00m n
}11 	
context33 
.33 
Items33 
.33 
Remove33 
(33 
item33 !
)33! "
;33" #
await44 
context44 
.44 
SaveChangesAsync44 &
(44& '
)44' (
;44( )
Log66 
.66 
Info66 
(66 
$"66 
$str66 
{66 
itemId66 
}66  
$str66  2
{662 3
userId663 9
}669 :
"66: ;
)66; <
;66< =
return77 
Results77 
.77 
	NoContent77  
(77  !
)77! "
;77" #
}88 
}99 ™
h/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Items/CreateItem/CreateItemRequest.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Items+ 0
.0 1

CreateItem1 ;
;; <
public 
record 
CreateItemRequest 
(  
string  &
Title' ,
,, -
string. 4
Description5 @
,@ A
CategoryB J
CategK P
,P Q
	ConditionR [
Cond\ `
,` a
decimalb i
?i j
	DailyRatek t
,t u
stringv |
?| }
ImageUrl	~ †
)
† ‡
;
‡ ˆ®E
h/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Items/CreateItem/CreateItemHandler.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Items+ 0
.0 1

CreateItem1 ;
;; <
public

 
class

 
CreateItemHandler

 
(

 
UniShareContext 
context 
, 

IValidator 
< 
CreateItemRequest  
>  !
	validator" +
,+ , 
IHttpContextAccessor 
httpContextAccessor ,
,, -
IHubContext 
< 
NotificationsHub  
>  !

hubContext" ,
), -
{ 
public 

async 
Task 
< 
IResult 
> 
Handle %
(% &
CreateItemRequest& 7
request8 ?
)? @
{ 
Log 
. 
Info 
( 
$" 
$str 6
{6 7
request7 >
.> ?
Title? D
}D E
$strE M
{M N
requestN U
.U V
CategV [
}[ \
$str\ c
{c d
requestd k
.k l
Condl p
}p q
"q r
)r s
;s t
var 
validationResult 
= 
await $
	validator% .
.. /
ValidateAsync/ <
(< =
request= D
)D E
;E F
if 

( 
! 
validationResult 
. 
IsValid %
)% &
{ 	
var 
errors 
= 
validationResult )
.) *
Errors* 0
. 
GroupBy 
( 
e 
=> 
e 
.  
PropertyName  ,
), -
. 
ToDictionary 
( 
g 
=> 
g 
. 
Key 
, 
g 
=> 
g 
. 
Select !
(! "
e" #
=>$ &
e' (
.( )
ErrorMessage) 5
)5 6
.6 7
ToArray7 >
(> ?
)? @
) 
; 
Log 
. 
Error 
( 
$" 
$str A
{A B
stringB H
.H I
JoinI M
(M N
$strN R
,R S
validationResultT d
.d e
Errorse k
.k l
Selectl r
(r s
es t
=>u w
$"x z
{z {
e{ |
.| }
PropertyName	} ‰
}
‰ Š
$str
Š ‹
{
‹ Œ
e
Œ 
.
 Ž
ErrorMessage
Ž š
}
š ›
"
› œ
)
œ 
)
 ž
}
ž Ÿ
"
Ÿ  
)
  ¡
;
¡ ¢
return 
Results 
. 
ValidationProblem ,
(, -
errors- 3
)3 4
;4 5
}   	
var"" 
("" 
userId"" 
,"" 
errorResult""  
)""  !
=""" #
await""$ )'
GetAuthenticatedUserIdAsync""* E
(""E F
)""F G
;""G H
if## 

(## 
errorResult## 
is## 
not## 
null## #
)### $
return##% +
errorResult##, 7
;##7 8
var%% 
item%% 
=%% 
new%% 
Item%% 
(%% 
Guid&& 
.&& 
NewGuid&& 
(&& 
)&& 
,&& 
userId'' 
!'' 
.'' 
Value'' 
,'' 
request(( 
.(( 
Title(( 
,(( 
request)) 
.)) 
Description)) 
,))  
request** 
.** 
Categ** 
,** 
request++ 
.++ 
Cond++ 
,++ 
request,, 
.,, 
	DailyRate,, 
,,, 
request-- 
.-- 
ImageUrl-- 
,-- 
true.. 
,.. 
DateTime// 
.// 
UtcNow// 
)00 	
;00	 

context22 
.22 
Items22 
.22 
Add22 
(22 
item22 
)22 
;22  
await33 
context33 
.33 
SaveChangesAsync33 &
(33& '
)33' (
;33( )
await44 

hubContext44 
.44 
Clients44  
.44  !
All44! $
.44$ %
	SendAsync44% .
(44. /
$str44/ <
,44< =
item44> B
)44B C
;44C D
Log66 
.66 
Info66 
(66 
$"66 
$str66 !
{66! "
item66" &
.66& '
Id66' )
}66) *
$str66* 6
"666 7
)667 8
;668 9
return77 
Results77 
.77 
Created77 
(77 
$"77 !
$str77! (
{77( )
item77) -
.77- .
Id77. 0
}770 1
"771 2
,772 3
item774 8
)778 9
;779 :
}88 
private:: 
async:: 
Task:: 
<:: 
(:: 
Guid:: 
?:: 
UserId:: $
,::$ %
IResult::& -
?::- .
ErrorResult::/ :
)::: ;
>::; <'
GetAuthenticatedUserIdAsync::= X
(::X Y
)::Y Z
{;; 
var<< 
httpContext<< 
=<< 
httpContextAccessor<< -
.<<- .
HttpContext<<. 9
;<<9 :
if== 

(== 
httpContext== 
is== 
null== 
)==  
{>> 	
Log?? 
.?? 
Error?? 
(?? 
$str?? +
)??+ ,
;??, -
return@@ 
(@@ 
null@@ 
,@@ 
Results@@ !
.@@! "
Unauthorized@@" .
(@@. /
)@@/ 0
)@@0 1
;@@1 2
}AA 	
ifCC 

(CC 
!CC 
httpContextCC 
.CC 
ItemsCC 
.CC 
TryGetValueCC *
(CC* +
$strCC+ 3
,CC3 4
outCC5 8
varCC9 <
	userIdObjCC= F
)CCF G
||CCH J
	userIdObjCCK T
isCCU W
notCCX [
GuidCC\ `
userIdCCa g
)CCg h
{DD 	
LogEE 
.EE 
ErrorEE 
(EE 
$"EE 
$strEE M
{EEM N
	userIdObjEEN W
}EEW X
"EEX Y
)EEY Z
;EEZ [
returnFF 
(FF 
nullFF 
,FF 
ResultsFF !
.FF! "
UnauthorizedFF" .
(FF. /
)FF/ 0
)FF0 1
;FF1 2
}GG 	
varII 
ownerExistsII 
=II 
awaitII 
contextII  '
.II' (
UsersII( -
.II- .
AnyAsyncII. 6
(II6 7
uII7 8
=>II9 ;
uII< =
.II= >
IdII> @
==IIA C
userIdIID J
)IIJ K
;IIK L
ifJJ 

(JJ 
!JJ 
ownerExistsJJ 
)JJ 
{KK 	
LogLL 
.LL 
ErrorLL 
(LL 
$"LL 
$strLL '
{LL' (
userIdLL( .
}LL. /
$strLL/ >
"LL> ?
)LL? @
;LL@ A
returnMM 
(MM 
nullMM 
,MM 
ResultsMM !
.MM! "

BadRequestMM" ,
(MM, -
newMM- 0
{MM1 2
errorsMM3 9
=MM: ;
newMM< ?
{MM@ A
OwnerIdMMB I
=MMJ K
newMML O
[MMO P
]MMP Q
{MMR S
$strMMT k
}MMl m
}MMn o
}MMp q
)MMq r
)MMr s
;MMs t
}NN 	
LogPP 
.PP 
InfoPP 
(PP 
$"PP 
$strPP <
{PP< =
userIdPP= C
}PPC D
"PPD E
)PPE F
;PPF G
returnQQ 
(QQ 
userIdQQ 
,QQ 
nullQQ 
)QQ 
;QQ 
}RR 
}SS Ý
l/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Bookings/GetAll/GettAllBookingsRequest.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Bookings+ 3
.3 4
GetAll4 :
;: ;
public 
record "
GettAllBookingsRequest $
($ %
Guid% )
UserId* 0
)0 1
;1 2–
j/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Bookings/GetAll/GetAllBookingHandler.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Bookings+ 3
.3 4
GetAll4 :
;: ;
public 
static 
class 
GetAllBookings "
{		 
public

 

record

 
Query

 
:

 
IRequest

 "
<

" #
IEnumerable

# .
<

. /
Booking

/ 6
>

6 7
>

7 8
;

8 9
public 

class 
Handler 
( 
UniShareContext (
context) 0
)0 1
:2 3
IRequestHandler4 C
<C D
QueryD I
,I J
IEnumerableK V
<V W
BookingW ^
>^ _
>_ `
{ 
public 
async 
Task 
< 
IEnumerable %
<% &
Booking& -
>- .
>. /
Handle0 6
(6 7
Query7 <
request= D
,D E
CancellationTokenF W
cancellationTokenX i
)i j
{ 	
Log 
. 
Info 
( 
$str 2
)2 3
;3 4
return 
await 
context  
.  !
Bookings! )
.) *
ToListAsync* 5
(5 6
cancellationToken6 G
)G H
;H I
} 	
} 
} Ý
q/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Bookings/CreateBooking/CreateBookingRequest.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Bookings+ 3
.3 4
CreateBooking4 A
;A B
public 
record  
CreateBookingRequest "
(" #
Guid# '
ItemId( .
,. /
DateTime0 8
	StartDate9 B
,B C
DateTimeD L
EndDateM T
)T U
;U Vû@
u/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Bookings/CompleteBooking/CompleteBookingHandler.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Bookings+ 3
.3 4
CompleteBooking4 C
;C D
public

 
class

 "
CompleteBookingHandler

 #
(

# $
UniShareContext 
context 
,  
IHttpContextAccessor 
httpContextAccessor ,
,, -
IHubContext 
< 
NotificationsHub  
>  !

hubContext" ,
), -
{ 
public 

async 
Task 
< 
IResult 
> 
Handle %
(% &
Guid& *
	bookingId+ 4
)4 5
{ 
var 
currentUserId 
= 
	GetUserId %
(% &
)& '
;' (
if 

( 
! 
currentUserId 
. 
HasValue #
)# $
return 
Results 
. 
Unauthorized '
(' (
)( )
;) *
var 
booking 
= 
await 
context #
.# $
Bookings$ ,
., -
FirstOrDefaultAsync- @
(@ A
bA B
=>C E
bF G
.G H
IdH J
==K M
	bookingIdN W
)W X
;X Y
if 

( 
booking 
is 
null 
) 
return 
Results 
. 
NotFound #
(# $
new$ '
{( )
error* /
=0 1
$str2 F
}G H
)H I
;I J
var 
item 
= 
await 
context  
.  !
Items! &
.& '
FirstOrDefaultAsync' :
(: ;
i; <
=>= ?
i@ A
.A B
IdB D
==E G
bookingH O
.O P
ItemIdP V
)V W
;W X
if 

( 
item 
is 
null 
) 
return 
Results 
. 
NotFound #
(# $
new$ '
{( )
error* /
=0 1
$str2 N
}O P
)P Q
;Q R
if 

( 
item 
. 
OwnerId 
!= 
currentUserId )
.) *
Value* /
)/ 0
return 
Results 
. 
Forbid !
(! "
)" #
;# $
if!! 

(!! 
booking!! 
.!! 
Status!! 
is!! 
not!! !
Status!!" (
.!!( )
Approved!!) 1
and!!2 5
not!!6 9
Status!!: @
.!!@ A
Active!!A G
)!!G H
{"" 	
return## 
Results## 
.## 

BadRequest## %
(##% &
new##& )
{##* +
error##, 1
=##2 3
$"##4 6
$str##6 i
{##i j
booking##j q
.##q r
Status##r x
}##x y
$str##y {
"##{ |
}##} ~
)##~ 
;	## €
}$$ 	
var&& 
updatedBooking&& 
=&& 
booking&& $
with&&% )
{'' 	
Status(( 
=(( 
Status(( 
.(( 
	Completed(( %
,((% &
ActualReturnDate)) 
=)) 
DateTime)) '
.))' (
UtcNow))( .
,)). /
CompletedAt** 
=** 
DateTime** "
.**" #
UtcNow**# )
}++ 	
;++	 

context-- 
.-- 
Entry-- 
(-- 
booking-- 
)-- 
.-- 
CurrentValues-- ,
.--, -
	SetValues--- 6
(--6 7
updatedBooking--7 E
)--E F
;--F G
var// 
updatedItem// 
=// 
await// 
MarkItemAvailable//  1
(//1 2
booking//2 9
.//9 :
ItemId//: @
)//@ A
;//A B
await11 
context11 
.11 
SaveChangesAsync11 &
(11& '
)11' (
;11( )
await33 

hubContext33 
.33 
Clients33  
.33  !
All33! $
.33$ %
	SendAsync33% .
(33. /
$str33/ ?
,33? @
updatedBooking33A O
)33O P
;33P Q
if44 

(44 
updatedItem44 
is44 
not44 
null44 #
)44# $
{55 	
await66 

hubContext66 
.66 
Clients66 $
.66$ %
All66% (
.66( )
	SendAsync66) 2
(662 3
$str663 @
,66@ A
updatedItem66B M
)66M N
;66N O
}77 	
Log99 
.99 
Info99 
(99 
$"99 
$str99 
{99 
	bookingId99 %
}99% &
$str99& M
{99M N
currentUserId99N [
.99[ \
Value99\ a
}99a b
"99b c
)99c d
;99d e
return;; 
Results;; 
.;; 
Ok;; 
(;; 
updatedBooking;; (
);;( )
;;;) *
}<< 
private>> 
Guid>> 
?>> 
	GetUserId>> 
(>> 
)>> 
{?? 
var@@ 
ctx@@ 
=@@ 
httpContextAccessor@@ %
.@@% &
HttpContext@@& 1
;@@1 2
ifAA 

(AA 
ctxAA 
?AA 
.AA 
ItemsAA 
isAA 
nullAA 
||AA !
!AA" #
ctxAA# &
.AA& '
ItemsAA' ,
.AA, -
TryGetValueAA- 8
(AA8 9
$strAA9 A
,AAA B
outAAC F
varAAG J
	userIdObjAAK T
)AAT U
)AAU V
{BB 	
returnCC 
nullCC 
;CC 
}DD 	
returnEE 
	userIdObjEE 
asEE 
GuidEE  
?EE  !
;EE! "
}FF 
privateHH 
asyncHH 
TaskHH 
<HH 
ItemHH 
?HH 
>HH 
MarkItemAvailableHH /
(HH/ 0
GuidHH0 4
itemIdHH5 ;
)HH; <
{II 
varJJ 
itemJJ 
=JJ 
awaitJJ 
contextJJ  
.JJ  !
ItemsJJ! &
.JJ& '
FirstOrDefaultAsyncJJ' :
(JJ: ;
iJJ; <
=>JJ= ?
iJJ@ A
.JJA B
IdJJB D
==JJE G
itemIdJJH N
)JJN O
;JJO P
ifKK 

(KK 
itemKK 
isKK 
nullKK 
)KK 
{LL 	
LogMM 
.MM 
WarningMM 
(MM 
$"MM 
$strMM 
{MM  
itemIdMM  &
}MM& '
$strMM' K
"MMK L
)MML M
;MMM N
returnNN 
nullNN 
;NN 
}OO 	
ifQQ 

(QQ 
itemQQ 
.QQ 
IsAvailableQQ 
)QQ 
returnRR 
itemRR 
;RR 
varTT 
updatedItemTT 
=TT 
itemTT 
withTT #
{TT$ %
IsAvailableTT& 1
=TT2 3
trueTT4 8
}TT9 :
;TT: ;
contextUU 
.UU 
EntryUU 
(UU 
itemUU 
)UU 
.UU 
CurrentValuesUU )
.UU) *
	SetValuesUU* 3
(UU3 4
updatedItemUU4 ?
)UU? @
;UU@ A
returnVV 
updatedItemVV 
;VV 
}WW 
}XX Ûs
q/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Bookings/CreateBooking/CreateBookingHandler.cs
	namespace		 	
UniShare		
 
.		 
Infrastructure		 !
.		! "
Features		" *
.		* +
Bookings		+ 3
.		3 4
CreateBooking		4 A
;		A B
public 
class  
CreateBookingHandler !
(! "
UniShareContext 
context 
, 

IValidator 
<  
CreateBookingRequest #
># $
	validator% .
,. / 
IHttpContextAccessor 
httpContextAccessor ,
,, -
IHubContext 
< 
NotificationsHub  
>  !

hubContext" ,
), -
{ 
public 

async 
Task 
< 
IResult 
> 
Handle %
(% & 
CreateBookingRequest& :
request; B
)B C
{ 
Log 
. 
Info 
( 
$" 
$str :
{: ;
request; B
.B C
ItemIdC I
}I J
$strJ V
{V W
requestW ^
.^ _
	StartDate_ h
}h i
$stri s
{s t
requestt {
.{ |
EndDate	| ƒ
}
ƒ „
"
„ …
)
… †
;
† ‡
var 
validationProblem 
= 
await  %
ValidateRequest& 5
(5 6
request6 =
)= >
;> ?
if 

( 
validationProblem 
is  
not! $
null% )
)) *
return 
validationProblem $
;$ %
var 

borrowerId 
= 
	GetUserId "
(" #
)# $
;$ %
if 

( 
! 

borrowerId 
. 
HasValue  
)  !
return 
Results 
. 
Unauthorized '
(' (
)( )
;) *
var 
item 
= 
await 
GetItem  
(  !
request! (
.( )
ItemId) /
)/ 0
;0 1
if 

( 
item 
is 
null 
) 
return "
ItemDoesNotExistResult )
() *
)* +
;+ ,
if!! 

(!! 
!!! 
item!! 
.!! 
IsAvailable!! 
)!! 
return"" 
Results"" 
."" 

BadRequest"" %
(""% &
new""& )
{""* +
error"", 1
=""2 3
$str""4 X
}""Y Z
)""Z [
;""[ \
Log$$ 
.$$ 
Info$$ 
($$ 
$"$$ 
$str$$ 9
{$$9 :

borrowerId$$: D
.$$D E
Value$$E J
}$$J K
$str$$K U
{$$U V
item$$V Z
.$$Z [
OwnerId$$[ b
}$$b c
"$$c d
)$$d e
;$$e f
if%% 

(%% 
item%% 
.%% 
OwnerId%% 
==%% 

borrowerId%% &
.%%& '
Value%%' ,
)%%, -
{&& 	
Log'' 
.'' 
Warning'' 
('' 
$str'' A
)''A B
;''B C
return(( 
Results(( 
.(( 

BadRequest(( %
(((% &
new((& )
{((* +
error((, 1
=((2 3
$str((4 V
}((W X
)((X Y
;((Y Z
})) 	
var++ 
conflictingBooking++ 
=++  
await++! &
context++' .
.++. /
Bookings++/ 7
.,, 
AnyAsync,, 
(,, 
b,, 
=>,, 
b,, 
.,, 
ItemId,, #
==,,$ &
request,,' .
.,,. /
ItemId,,/ 5
&&,,6 8
(-- 
b-- 
.-- 
Status-- $
==--% '
Status--( .
.--. /
Pending--/ 6
||--7 9
b--: ;
.--; <
Status--< B
==--C E
Status--F L
.--L M
Approved--M U
||--V X
b--Y Z
.--Z [
Status--[ a
==--b d
Status--e k
.--k l
Active--l r
)--r s
&&--t v
request.. "
..." #
	StartDate..# ,
<..- .
b../ 0
...0 1
EndDate..1 8
&&..9 ;
request..< C
...C D
EndDate..D K
>..L M
b..N O
...O P
	StartDate..P Y
)..Y Z
;..Z [
if00 

(00 
conflictingBooking00 
)00 
return11 
Results11 
.11 

BadRequest11 %
(11% &
new11& )
{11* +
error11, 1
=112 3
$str114 d
}11e f
)11f g
;11g h
var33 
ownerId33 
=33 
item33 
.33 
OwnerId33 "
;33" #
if44 

(44 
!44 
await44 

UserExists44 
(44 
ownerId44 %
)44% &
)44& '
return55 #
OwnerDoesNotExistResult55 *
(55* +
)55+ ,
;55, -
var77 
booking77 
=77 
CreateBooking77 #
(77# $
request77$ +
,77+ ,

borrowerId77- 7
.777 8
Value778 =
,77= >
ownerId77? F
,77F G
item77H L
)77L M
;77M N
var88 
updatedItem88 
=88 
item88 
with88 #
{88$ %
IsAvailable88& 1
=882 3
false884 9
}88: ;
;88; <
context99 
.99 
Entry99 
(99 
item99 
)99 
.99 
CurrentValues99 )
.99) *
	SetValues99* 3
(993 4
updatedItem994 ?
)99? @
;99@ A
await;; 
context;; 
.;; 
SaveChangesAsync;; &
(;;& '
);;' (
;;;( )
await== 

hubContext== 
.== 
Clients==  
.==  !
All==! $
.==$ %
	SendAsync==% .
(==. /
$str==/ ?
,==? @
booking==A H
)==H I
;==I J
await>> 

hubContext>> 
.>> 
Clients>>  
.>>  !
All>>! $
.>>$ %
	SendAsync>>% .
(>>. /
$str>>/ <
,>>< =
updatedItem>>> I
)>>I J
;>>J K
return@@ 
Results@@ 
.@@ 
Created@@ 
(@@ 
$"@@ !
$str@@! +
{@@+ ,
booking@@, 3
.@@3 4
Id@@4 6
}@@6 7
"@@7 8
,@@8 9
booking@@: A
)@@A B
;@@B C
}AA 
privateCC 
asyncCC 
TaskCC 
<CC 
IResultCC 
?CC 
>CC  
ValidateRequestCC! 0
(CC0 1 
CreateBookingRequestCC1 E
requestCCF M
)CCM N
{DD 
varEE 

validationEE 
=EE 
awaitEE 
	validatorEE (
.EE( )
ValidateAsyncEE) 6
(EE6 7
requestEE7 >
)EE> ?
;EE? @
ifFF 

(FF 

validationFF 
.FF 
IsValidFF 
)FF 
returnGG 
nullGG 
;GG 
varII 
errorsII 
=II 

validationII 
.II  
ErrorsII  &
.JJ 
GroupByJJ 
(JJ 
eJJ 
=>JJ 
eJJ 
.JJ 
PropertyNameJJ (
)JJ( )
.KK 
ToDictionaryKK 
(KK 
gKK 
=>KK 
gKK  
.KK  !
KeyKK! $
,KK$ %
gKK& '
=>KK( *
gKK+ ,
.KK, -
SelectKK- 3
(KK3 4
eKK4 5
=>KK6 8
eKK9 :
.KK: ;
ErrorMessageKK; G
)KKG H
.KKH I
ToArrayKKI P
(KKP Q
)KKQ R
)KKR S
;KKS T
LogMM 
.MM 
ErrorMM 
(MM 
$strMM %
)MM% &
;MM& '
returnNN 
ResultsNN 
.NN 
ValidationProblemNN (
(NN( )
errorsNN) /
)NN/ 0
;NN0 1
}OO 
privateQQ 
GuidQQ 
?QQ 
	GetUserIdQQ 
(QQ 
)QQ 
{RR 
varSS 
ctxSS 
=SS 
httpContextAccessorSS %
.SS% &
HttpContextSS& 1
;SS1 2
ifTT 

(TT 
ctxTT 
==TT 
nullTT 
)TT 
returnTT 
nullTT  $
;TT$ %
ctxVV 
.VV 
ItemsVV 
.VV 
TryGetValueVV 
(VV 
$strVV &
,VV& '
outVV( +
varVV, /
	userIdObjVV0 9
)VV9 :
;VV: ;
returnWW 
	userIdObjWW 
isWW 
GuidWW  
idWW! #
?WW$ %
idWW& (
:WW) *
nullWW+ /
;WW/ 0
}XX 
privateZZ 
asyncZZ 
TaskZZ 
<ZZ 
boolZZ 
>ZZ 

UserExistsZZ '
(ZZ' (
GuidZZ( ,
idZZ- /
)ZZ/ 0
=>[[ 

await[[ 
context[[ 
.[[ 
Users[[ 
.[[ 
AnyAsync[[ '
([[' (
u[[( )
=>[[* ,
u[[- .
.[[. /
Id[[/ 1
==[[2 4
id[[5 7
)[[7 8
;[[8 9
private]] 
async]] 
Task]] 
<]] 
Item]] 
?]] 
>]] 
GetItem]] %
(]]% &
Guid]]& *
id]]+ -
)]]- .
=>^^ 

await^^ 
context^^ 
.^^ 
Items^^ 
.^^ 
FirstOrDefaultAsync^^ 2
(^^2 3
i^^3 4
=>^^5 7
i^^8 9
.^^9 :
Id^^: <
==^^= ?
id^^@ B
)^^B C
;^^C D
private`` 
static`` 
IResult`` "
ItemDoesNotExistResult`` 1
(``1 2
)``2 3
=>aa 

Resultsaa 
.aa 

BadRequestaa 
(aa 
newaa !
{aa" #
errorsaa$ *
=aa+ ,
newaa- 0
{aa1 2
ItemIdaa3 9
=aa: ;
newaa< ?
[aa? @
]aa@ A
{aaB C
$straaD Z
}aa[ \
}aa] ^
}aa_ `
)aa` a
;aaa b
privatecc 
staticcc 
IResultcc #
OwnerDoesNotExistResultcc 2
(cc2 3
)cc3 4
=>dd 

Resultsdd 
.dd 

BadRequestdd 
(dd 
newdd !
{dd" #
errorsdd$ *
=dd+ ,
newdd- 0
{dd1 2
OwnerIddd3 :
=dd; <
newdd= @
[dd@ A
]ddA B
{ddC D
$strddE \
}dd] ^
}dd_ `
}dda b
)ddb c
;ddc d
privateff 
Bookingff 
CreateBookingff !
(ff! " 
CreateBookingRequestgg 
requestgg $
,gg$ %
Guidhh 

borrowerIdhh 
,hh 
Guidii 
ownerIdii 
,ii 
Itemjj 
itemjj 
)jj 
{kk 
varll 

totalPricell 
=ll 
CalculatePricell '
(ll' (
itemll( ,
.ll, -
	DailyRatell- 6
,ll6 7
requestll8 ?
.ll? @
	StartDatell@ I
,llI J
requestllK R
.llR S
EndDatellS Z
)llZ [
;ll[ \
varnn 
bookingnn 
=nn 
newnn 
Bookingnn !
(nn! "
Guidoo 
.oo 
NewGuidoo 
(oo 
)oo 
,oo 
requestpp 
.pp 
ItemIdpp 
,pp 

borrowerIdqq 
,qq 
ownerIdrr 
,rr 
Statusss 
.ss 
Pendingss 
,ss 
requesttt 
.tt 
	StartDatett 
,tt 
requestuu 
.uu 
EndDateuu 
,uu 
defaultvv 
,vv 

totalPriceww 
,ww 
DateTimexx 
.xx 
UtcNowxx 
,xx 
defaultyy 
,yy 
defaultzz 
){{ 	
;{{	 

context}} 
.}} 
Bookings}} 
.}} 
Add}} 
(}} 
booking}} $
)}}$ %
;}}% &
Log 
. 
Info 
( 
$" 
$str $
{$ %
booking% ,
., -
Id- /
}/ 0
"0 1
)1 2
;2 3
return
€€ 
booking
€€ 
;
€€ 
}
 
private
ƒƒ 
static
ƒƒ 
decimal
ƒƒ 
CalculatePrice
ƒƒ )
(
ƒƒ) *
decimal
ƒƒ* 1
?
ƒƒ1 2
rate
ƒƒ3 7
,
ƒƒ7 8
DateTime
ƒƒ9 A
start
ƒƒB G
,
ƒƒG H
DateTime
ƒƒI Q
end
ƒƒR U
)
ƒƒU V
{
„„ 
if
…… 

(
…… 
!
…… 
rate
…… 
.
…… 
HasValue
…… 
)
…… 
return
…… "
$num
……# %
;
……% &
var
‡‡ 
days
‡‡ 
=
‡‡ 
Math
‡‡ 
.
‡‡ 
Max
‡‡ 
(
‡‡ 
$num
‡‡ 
,
‡‡ 
(
‡‡  
end
‡‡  #
.
‡‡# $
Date
‡‡$ (
-
‡‡) *
start
‡‡+ 0
.
‡‡0 1
Date
‡‡1 5
)
‡‡5 6
.
‡‡6 7
	TotalDays
‡‡7 @
)
‡‡@ A
;
‡‡A B
return
ˆˆ 
rate
ˆˆ 
.
ˆˆ 
Value
ˆˆ 
*
ˆˆ 
(
ˆˆ 
decimal
ˆˆ $
)
ˆˆ$ %
days
ˆˆ% )
;
ˆˆ) *
}
‰‰ 
}ŠŠ ¢1
g/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Bookings/BookingBackgroundService.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Bookings+ 3
;3 4
public 
class $
BookingBackgroundService %
(% &
IServiceProvider& 6
serviceProvider7 F
)F G
:H I
BackgroundServiceJ [
{ 
	protected		 
override		 
async		 
Task		 !
ExecuteAsync		" .
(		. /
CancellationToken		/ @
stoppingToken		A N
)		N O
{

 
while 
( 
! 
stoppingToken 
. #
IsCancellationRequested 5
)5 6
{ 	
await 
using 
( 
var 
scope "
=# $
serviceProvider% 4
.4 5
CreateAsyncScope5 E
(E F
)F G
)G H
{ 
var 
	dbContext 
= 
scope  %
.% &
ServiceProvider& 5
.5 6
GetRequiredService6 H
<H I
UniShareContextI X
>X Y
(Y Z
)Z [
;[ \
await (
MarkExpiredBookingsAsExpired 2
(2 3
	dbContext3 <
)< =
;= >
await &
MarkActiveBookingsAsActive 0
(0 1
	dbContext1 :
): ;
;; <
} 
await 
Task 
. 
Delay 
( 
TimeSpan %
.% &
	FromHours& /
(/ 0
$num0 1
)1 2
,2 3
stoppingToken4 A
)A B
;B C
} 	
} 
private 
static 
async 
Task (
MarkExpiredBookingsAsExpired :
(: ;
UniShareContext; J
	dbContextK T
)T U
{ 
try 
{ 	
var 
expiredBookings 
=  !
await" '
	dbContext( 1
.1 2
Bookings2 :
. 
Where 
( 
b 
=> 
b 
. 
Status $
==% '
Status( .
.. /
Active/ 5
&&6 8
b9 :
.: ;
EndDate; B
<C D
DateTimeE M
.M N
UtcNowN T
)T U
. 
ToListAsync 
( 
) 
; 
if 
( 
expiredBookings 
.  
Count  %
==& (
$num) *
)* +
return   
;   
foreach"" 
("" 
var"" 
booking""  
in""! #
expiredBookings""$ 3
)""3 4
{## 
var$$ 
updatedBooking$$ "
=$$# $
booking$$% ,
with$$- 1
{$$2 3
Status$$4 :
=$$; <
Status$$= C
.$$C D
Expired$$D K
}$$L M
;$$M N
	dbContext%% 
.%% 
Entry%% 
(%%  
booking%%  '
)%%' (
.%%( )
CurrentValues%%) 6
.%%6 7
	SetValues%%7 @
(%%@ A
updatedBooking%%A O
)%%O P
;%%P Q
}&& 
await(( 
	dbContext(( 
.(( 
SaveChangesAsync(( ,
(((, -
)((- .
;((. /
})) 	
catch** 
(** 
	Exception** 
ex** 
)** 
{++ 	
Log.. 
... 
Error.. 
(.. 
$".. 
$str.. 8
{..8 9
ex..9 ;
...; <
Message..< C
}..C D
"..D E
)..E F
;..F G
}// 	
}00 
private22 
static22 
async22 
Task22 &
MarkActiveBookingsAsActive22 8
(228 9
UniShareContext229 H
	dbContext22I R
)22R S
{33 
try44 
{55 	
var66 
activeBookings66 
=66  
await66! &
	dbContext66' 0
.660 1
Bookings661 9
.77 
Where77 
(77 
b77 
=>77 
b77 
.77 
Status77 $
==77% '
Status77( .
.77. /
Approved77/ 7
&&778 :
b77; <
.77< =
	StartDate77= F
<=77G I
DateTime77J R
.77R S
UtcNow77S Y
)77Y Z
.88 
ToListAsync88 
(88 
)88 
;88 
if:: 
(:: 
activeBookings:: 
.:: 
Count:: $
==::% '
$num::( )
)::) *
return;; 
;;; 
foreach== 
(== 
var== 
booking==  
in==! #
activeBookings==$ 2
)==2 3
{>> 
var?? 
updatedBooking?? "
=??# $
booking??% ,
with??- 1
{??2 3
Status??4 :
=??; <
Status??= C
.??C D
Active??D J
}??K L
;??L M
	dbContext@@ 
.@@ 
Entry@@ 
(@@  
booking@@  '
)@@' (
.@@( )
CurrentValues@@) 6
.@@6 7
	SetValues@@7 @
(@@@ A
updatedBooking@@A O
)@@O P
;@@P Q
}AA 
awaitCC 
	dbContextCC 
.CC 
SaveChangesAsyncCC ,
(CC, -
)CC- .
;CC. /
}DD 	
catchEE 
(EE 
	ExceptionEE 
exEE 
)EE 
{FF 	
LogHH 
.HH 
ErrorHH 
(HH 
$"HH 
$strHH 7
{HH7 8
exHH8 :
.HH: ;
MessageHH; B
}HHB C
"HHC D
)HHD E
;HHE F
}II 	
}JJ 
}KK ä
V/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Bookings/Booking.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Bookings+ 3
;3 4
public 
enum 
Status 
{ 
Pending		 
=		 
$num		 
,		 
Approved

 
=

 
$num

 
,

 
Active 

= 
$num 
, 
	Completed 
= 
$num 
, 
Canceled 
= 
$num 
, 
Rejected 
= 
$num 
, 
Expired 
= 
$num 
} 
public 
record 
Booking 
( 
Guid 
Id 
, 
Guid #
ItemId$ *
,* +
Guid, 0

BorrowerId1 ;
,; <
Guid= A
OwnerIdB I
,I J
StatusK Q
StatusR X
,X Y
DateTimeZ b
	StartDatec l
,l m
DateTimen v
EndDatew ~
,~ 
DateTime
€ ˆ
ActualReturnDate
‰ ™
,
™ š
Decimal
› ¢

TotalPrice
£ ­
,
­ ®
DateTime
¯ ·
RequestedAt
¸ Ã
,
Ã Ä
DateTime
Å Í

ApprovedAt
Î Ø
,
Ø Ù
DateTime
Ú â
CompletedAt
ã î
)
î ï
;
ï ð¤
s/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Bookings/ApproveBooking/ApproveBookingRequest.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Bookings+ 3
.3 4
ApproveBooking4 B
;B C
public 
record !
ApproveBookingRequest #
(# $
Guid$ (
	BookingId) 2
,2 3
bool4 8
Approve9 @
)@ A
;A B›g
s/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Bookings/ApproveBooking/ApproveBookingHandler.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Bookings+ 3
.3 4
ApproveBooking4 B
;B C
public

 
class

 !
ApproveBookingHandler

 "
(

" #
UniShareContext 
context 
,  
IHttpContextAccessor 
httpContextAccessor ,
,, -
IHubContext 
< 
NotificationsHub  
>  !

hubContext" ,
), -
{ 
public 

async 
Task 
< 
IResult 
> 
Handle %
(% &!
ApproveBookingRequest& ;
request< C
)C D
{ 
Log 
. 
Info 
( 
$" 
$str >
{> ?
request? F
.F G
	BookingIdG P
}P Q
$strQ [
{[ \
request\ c
.c d
Approved k
}k l
"l m
)m n
;n o
var 
ownerId 
= 
	GetUserId 
(  
)  !
;! "
if 

( 
ownerId 
is 
null 
) 
return 
Results 
. 
Unauthorized '
(' (
)( )
;) *
var 
booking 
= 
await 

GetBooking &
(& '
request' .
.. /
	BookingId/ 8
)8 9
;9 :
if 

( 
booking 
is 
null 
) 
return 
Results 
. 
NotFound #
(# $
new$ '
{( )
message* 1
=2 3
$str4 H
}I J
)J K
;K L
var 
authorizationResult 
=  !
ValidateOwner" /
(/ 0
booking0 7
,7 8
ownerId9 @
.@ A
ValueA F
)F G
;G H
if 

( 
authorizationResult 
is  "
not# &
null' +
)+ ,
return 
authorizationResult &
;& '
var 
statusValidation 
= !
ValidateBookingStatus 4
(4 5
booking5 <
)< =
;= >
if   

(   
statusValidation   
is   
not    #
null  $ (
)  ( )
return!! 
statusValidation!! #
;!!# $
var## 
(## 
updatedBooking## 
,## 
updatedItem## (
)##( )
=##* +
await##, 1
ApplyDecisionAsync##2 D
(##D E
booking##E L
,##L M
request##N U
.##U V
Approve##V ]
)##] ^
;##^ _
await%% 

hubContext%% 
.%% 
Clients%%  
.%%  !
All%%! $
.%%$ %
	SendAsync%%% .
(%%. /
$str%%/ ?
,%%? @
updatedBooking%%A O
)%%O P
;%%P Q
if&& 

(&& 
updatedItem&& 
is&& 
not&& 
null&& #
)&&# $
{'' 	
await(( 

hubContext(( 
.(( 
Clients(( $
.(($ %
All((% (
.((( )
	SendAsync(() 2
(((2 3
$str((3 @
,((@ A
updatedItem((B M
)((M N
;((N O
})) 	
return++ 
Results++ 
.++ 
Ok++ 
(++ 
updatedBooking++ (
)++( )
;++) *
},, 
private00 
Guid00 
?00 
	GetUserId00 
(00 
)00 
{11 
var22 
httpContext22 
=22 
httpContextAccessor22 -
.22- .
HttpContext22. 9
;229 :
if33 

(33 
httpContext33 
==33 
null33 
)33  
{44 	
Log55 
.55 
Error55 
(55 
$str55 +
)55+ ,
;55, -
return66 
null66 
;66 
}77 	
httpContext99 
.99 
Items99 
.99 
TryGetValue99 %
(99% &
$str99& .
,99. /
out990 3
var994 7
	userIdObj998 A
)99A B
;99B C
return:: 
	userIdObj:: 
is:: 
Guid::  
g::! "
?::# $
g::% &
:::' (
null::) -
;::- .
};; 
private== 
Task== 
<== 
Booking== 
?== 
>== 

GetBooking== %
(==% &
Guid==& *
id==+ -
)==- .
=>==/ 1
context>> 
.>> 
Bookings>> 
.>> 
FirstOrDefaultAsync>> ,
(>>, -
b>>- .
=>>>/ 1
b>>2 3
.>>3 4
Id>>4 6
==>>7 9
id>>: <
)>>< =
;>>= >
private@@ 
Task@@ 
<@@ 
Booking@@ 
?@@ 
>@@ 
GetBookingReadonly@@ -
(@@- .
Guid@@. 2
id@@3 5
)@@5 6
=>@@7 9
contextAA 
.AA 
BookingsAA 
.AA 
AsNoTrackingAA %
(AA% &
)AA& '
.AA' (
FirstOrDefaultAsyncAA( ;
(AA; <
bAA< =
=>AA> @
bAAA B
.AAB C
IdAAC E
==AAF H
idAAI K
)AAK L
;AAL M
privateCC 
staticCC 
IResultCC 
?CC 
ValidateOwnerCC )
(CC) *
BookingCC* 1
bookingCC2 9
,CC9 :
GuidCC; ?
ownerIdCC@ G
)CCG H
{DD 
ifEE 

(EE 
bookingEE 
.EE 
OwnerIdEE 
==EE 
ownerIdEE &
)EE& '
returnEE( .
nullEE/ 3
;EE3 4
LogFF 
.FF 
ErrorFF 
(FF 
$"FF 
$strFF 
{FF 
ownerIdFF !
}FF! "
$strFF" ?
{FF? @
bookingFF@ G
.FFG H
IdFFH J
}FFJ K
"FFK L
)FFL M
;FFM N
returnGG 
ResultsGG 
.GG 
ForbidGG 
(GG 
)GG 
;GG  
}II 
privateKK 
staticKK 
IResultKK 
?KK !
ValidateBookingStatusKK 1
(KK1 2
BookingKK2 9
bookingKK: A
)KKA B
{LL 
ifMM 

(MM 
bookingMM 
.MM 
StatusMM 
==MM 
StatusMM $
.MM$ %
PendingMM% ,
)MM, -
returnMM. 4
nullMM5 9
;MM9 :
LogNN 
.NN 
ErrorNN 
(NN 
$"NN 
$strNN 
{NN 
bookingNN $
.NN$ %
IdNN% '
}NN' (
$strNN( I
{NNI J
bookingNNJ Q
.NNQ R
StatusNNR X
}NNX Y
"NNY Z
)NNZ [
;NN[ \
returnOO 
ResultsOO 
.OO 

BadRequestOO !
(OO! "
newOO" %
{OO& '
messageOO( /
=OO0 1
$strOO2 f
}OOg h
)OOh i
;OOi j
}QQ 
privateSS 
asyncSS 
TaskSS 
<SS 
(SS 
BookingSS 
UpdatedBookingSS  .
,SS. /
ItemSS0 4
?SS4 5
UpdatedItemSS6 A
)SSA B
>SSB C
ApplyDecisionAsyncSSD V
(SSV W
BookingSSW ^
bookingSS_ f
,SSf g
boolSSh l
approveSSm t
)SSt u
{TT 
varUU 
nowUU 
=UU 
DateTimeUU 
.UU 
UtcNowUU !
;UU! "
varVV 
	newStatusVV 
=VV 
approveVV 
?VV  !
StatusVV" (
.VV( )
ApprovedVV) 1
:VV2 3
StatusVV4 :
.VV: ;
RejectedVV; C
;VVC D
ItemWW 
?WW 
updatedItemWW 
=WW 
nullWW  
;WW  !
varZZ 
updatedBookingZZ 
=ZZ 
bookingZZ $
withZZ% )
{[[ 	
Status\\ 
=\\ 
	newStatus\\ 
,\\ 

ApprovedAt]] 
=]] 
approve]]  
?]]! "
now]]# &
:]]' (
booking]]) 0
.]]0 1

ApprovedAt]]1 ;
}^^ 	
;^^	 

context`` 
.`` 
Entry`` 
(`` 
booking`` 
)`` 
.`` 
CurrentValues`` ,
.``, -
	SetValues``- 6
(``6 7
updatedBooking``7 E
)``E F
;``F G
ifbb 

(bb 
approvebb 
)bb 
{cc 	
updatedItemdd 
=dd 
awaitdd 
MarkItemUnavailabledd  3
(dd3 4
bookingdd4 ;
.dd; <
ItemIddd< B
)ddB C
;ddC D
}ee 	
elseff 
{gg 	
updatedItemhh 
=hh 
awaithh 
MarkItemAvailablehh  1
(hh1 2
bookinghh2 9
.hh9 :
ItemIdhh: @
)hh@ A
;hhA B
}ii 	
awaitkk 
contextkk 
.kk 
SaveChangesAsynckk &
(kk& '
)kk' (
;kk( )
Logmm 
.mm 
Infomm 
(mm 
$"mm 
$strmm 
{mm 
bookingmm #
.mm# $
Idmm$ &
}mm& '
$strmm' ,
{mm, -
(mm- .
approvemm. 5
?mm6 7
$strmm8 B
:mmC D
$strmmE O
)mmO P
}mmP Q
"mmQ R
)mmR S
;mmS T
returnnn 
(nn 
updatedBookingnn 
,nn 
updatedItemnn  +
)nn+ ,
;nn, -
}oo 
privateqq 
asyncqq 
Taskqq 
<qq 
Itemqq 
?qq 
>qq 
MarkItemUnavailableqq 1
(qq1 2
Guidqq2 6
itemIdqq7 =
)qq= >
{rr 
varss 
itemss 
=ss 
awaitss 
contextss  
.ss  !
Itemsss! &
.ss& '
FirstOrDefaultAsyncss' :
(ss: ;
iss; <
=>ss= ?
iss@ A
.ssA B
IdssB D
==ssE G
itemIdssH N
)ssN O
;ssO P
iftt 

(tt 
itemtt 
==tt 
nulltt 
)tt 
returntt  
nulltt! %
;tt% &
varvv 
updatedItemvv 
=vv 
itemvv 
withvv #
{vv$ %
IsAvailablevv& 1
=vv2 3
falsevv4 9
}vv: ;
;vv; <
contextxx 
.xx 
Entryxx 
(xx 
itemxx 
)xx 
.xx 
CurrentValuesxx )
.xx) *
	SetValuesxx* 3
(xx3 4
updatedItemxx4 ?
)xx? @
;xx@ A
returnyy 
updatedItemyy 
;yy 
}zz 
private|| 
async|| 
Task|| 
<|| 
Item|| 
?|| 
>|| 
MarkItemAvailable|| /
(||/ 0
Guid||0 4
itemId||5 ;
)||; <
{}} 
var~~ 
item~~ 
=~~ 
await~~ 
context~~  
.~~  !
Items~~! &
.~~& '
FirstOrDefaultAsync~~' :
(~~: ;
i~~; <
=>~~= ?
i~~@ A
.~~A B
Id~~B D
==~~E G
itemId~~H N
)~~N O
;~~O P
if 

( 
item 
== 
null 
) 
return  
null! %
;% &
var
 
updatedItem
 
=
 
item
 
with
 #
{
$ %
IsAvailable
& 1
=
2 3
true
4 8
}
9 :
;
: ;
context
‚‚ 
.
‚‚ 
Entry
‚‚ 
(
‚‚ 
item
‚‚ 
)
‚‚ 
.
‚‚ 
CurrentValues
‚‚ )
.
‚‚) *
	SetValues
‚‚* 3
(
‚‚3 4
updatedItem
‚‚4 ?
)
‚‚? @
;
‚‚@ A
return
ƒƒ 
updatedItem
ƒƒ 
;
ƒƒ 
}
„„ 
}…… æ
p/home/cossi/Code/UniShare/Backend/UniShare/Infrastructure/Features/Bookings/ApproveBooking/ApproveBookingBody.cs
	namespace 	
UniShare
 
. 
Infrastructure !
.! "
Features" *
.* +
Bookings+ 3
.3 4
ApproveBooking4 B
;B C
public 
record 
ApproveBookingBody  
(  !
bool! %
Approve& -
)- .
;. /D
B/home/cossi/Code/UniShare/Backend/UniShare/Domain/Entities/User.csº*
8/home/cossi/Code/UniShare/Backend/UniShare/Common/Log.cs
	namespace 	
UniShare
 
. 
Common 
{ 
public 

static 
class 
Log 
{ 
private 
static 
readonly 
string  &
LogFilePath' 2
=3 4!
InitializeLogFilePath5 J
(J K
)K L
;L M
private 
static 
readonly 
object  &
Lock' +
=, -
new. 1
object2 8
(8 9
)9 :
;: ;
private 
static 
string !
InitializeLogFilePath 3
(3 4
)4 5
{		 	
try

 
{ 
var 
projectRoot 
=  !
	Directory" +
.+ ,
	GetParent, 5
(5 6

AppContext6 @
.@ A
BaseDirectoryA N
)N O
?O P
.P Q
ParentQ W
?W X
.X Y
ParentY _
?_ `
.` a
Parenta g
?g h
.h i
FullNamei q
;q r
var 
logDirectory  
=! "
projectRoot# .
!=/ 1
null2 6
?7 8
Path9 =
.= >
Combine> E
(E F
projectRootF Q
,Q R
$strS Y
)Y Z
:[ \
$str] c
;c d
var 
logFilePath 
=  !
Path" &
.& '
Combine' .
(. /
logDirectory/ ;
,; <
$str= F
)F G
;G H
if 
( 
! 
	Directory 
. 
Exists %
(% &
logDirectory& 2
)2 3
)3 4
{ 
	Directory 
. 
CreateDirectory -
(- .
logDirectory. :
): ;
;; <
} 
return 
logFilePath "
;" #
} 
catch 
( 
	Exception 
ex 
)  
{ 
Console 
. 
	WriteLine !
(! "
$"" $
$str$ D
{D E
exE G
.G H
MessageH O
}O P
"P Q
)Q R
;R S
return 
$str  
;  !
} 
} 	
public 
static 
void 
Info 
(  
string  &
message' .
). /
{   	
WriteLog!! 
(!! 
$str!! 
,!! 
message!! $
)!!$ %
;!!% &
}"" 	
public$$ 
static$$ 
void$$ 
Warning$$ "
($$" #
string$$# )
message$$* 1
)$$1 2
{%% 	
WriteLog&& 
(&& 
$str&& 
,&& 
message&&  '
)&&' (
;&&( )
}'' 	
public)) 
static)) 
void)) 
Error))  
())  !
string))! '
message))( /
,))/ 0
	Exception))1 :
?)): ;
ex))< >
=))? @
null))A E
)))E F
{** 	
var++ 
errorMessage++ 
=++ 
ex++ !
!=++" $
null++% )
?++* +
$"++, .
{++. /
message++/ 6
}++6 7
$str++7 E
{++E F
ex++F H
}++H I
"++I J
:++K L
message++M T
;++T U
WriteLog,, 
(,, 
$str,, 
,,, 
errorMessage,, *
),,* +
;,,+ ,
}-- 	
private// 
static// 
void// 
WriteLog// $
(//$ %
string//% +
level//, 1
,//1 2
string//3 9
message//: A
)//A B
{00 	
lock11 
(11 
Lock11 
)11 
{22 
try33 
{44 
var55 

logMessage55 "
=55# $
$"55% '
{55' (
DateTime55( 0
.550 1
Now551 4
:554 5
$str555 H
}55H I
$str55I K
{55K L
level55L Q
}55Q R
$str55R T
{55T U
message55U \
}55\ ]
"55] ^
;55^ _
Console66 
.66 
	WriteLine66 %
(66% &

logMessage66& 0
)660 1
;661 2
File77 
.77 
AppendAllText77 &
(77& '
LogFilePath77' 2
,772 3

logMessage774 >
+77? @
Environment77A L
.77L M
NewLine77M T
)77T U
;77U V
}88 
catch99 
(99 
	Exception99  
ex99! #
)99# $
{:: 
Console;; 
.;; 
	WriteLine;; %
(;;% &
$";;& (
$str;;( E
{;;E F
ex;;F H
.;;H I
Message;;I P
};;P Q
";;Q R
);;R S
;;;S T
}<< 
}== 
}>> 	
}?? 
}@@ é
M/home/cossi/Code/UniShare/Backend/UniShare/Common/AuthenticationMiddleware.cs
	namespace 	
UniShare
 
. 
Common 
; 
public 
class $
AuthenticationMiddleware %
(% &
RequestDelegate& 5
next6 :
): ;
{ 
public 

async 
Task 
InvokeAsync !
(! "
HttpContext" -
context. 5
)5 6
{ 
var 

authHeader 
= 
context  
.  !
Request! (
.( )
Headers) 0
[0 1
$str1 @
]@ A
.A B
FirstOrDefaultB P
(P Q
)Q R
;R S
var		 
token		 
=		 

authHeader		 
?		 
.		  
Split		  %
(		% &
$str		& )
)		) *
.		* +
LastOrDefault		+ 8
(		8 9
)		9 :
;		: ;
if 

( 
! 
string 
. 
IsNullOrEmpty !
(! "
token" '
)' (
&&) +
token, 1
.1 2

StartsWith2 <
(< =
$str= J
)J K
)K L
{ 	
var 
userIdString 
= 
token $
.$ %
Replace% ,
(, -
$str- :
,: ;
$str< >
)> ?
;? @
if 
( 
Guid 
. 
TryParse 
( 
userIdString *
,* +
out, /
var0 3
userId4 :
): ;
); <
{ 
context 
. 
Items 
[ 
$str &
]& '
=( )
userId* 0
;0 1
} 
} 	
await 
next 
( 
context 
) 
; 
} 
} 
public 
static 
class .
"AuthenticationMiddlewareExtensions 6
{ 
public 

static 
void '
UseAuthenticationMiddleware 2
(2 3
this3 7
IApplicationBuilder8 K
builderL S
)S T
{ 
builder 
. 
UseMiddleware 
< $
AuthenticationMiddleware 6
>6 7
(7 8
)8 9
;9 :
} 
} ã
9/home/cossi/Code/UniShare/Backend/UniShare/Api/UserApi.cs
	namespace 	
UniShare
 
. 
Api 
; 
public 
static 
class 
UserApi 
{		 
public

 

static

 
void

 
MapUserEndpoints

 '
(

' (
this

( ,!
IEndpointRouteBuilder

- B
app

C F
)

F G
{ 
app 
. 
MapGet 
( 
$str 
, 
async "
(# $
[$ %
FromServices% 1
]1 2
GetAllUsersHandler3 E
handlerF M
)M N
=>O Q
awaitR W
handlerX _
._ `
Handle` f
(f g
)g h
)h i
. 
WithName 
( 
$str #
)# $
;$ %
app 
. 
MapPost 
( 
$str (
,( )
async* /
(0 1
RegisterUserRequest1 D
requestE L
,L M
[N O
FromServicesO [
][ \
RegisterUserHandler] p
handlerq x
)x y
=>z |
await	} ‚
handler
ƒ Š
.
Š ‹
Handle
‹ ‘
(
‘ ’
request
’ ™
)
™ š
)
š ›
. 
WithName 
( 
$str $
)$ %
;% &
app 
. 
MapPost 
( 
$str %
,% &
async' ,
(- .
LoginRequest. :
request; B
,B C
[D E
FromServicesE Q
]Q R
LoginHandlerS _
handler` g
)g h
=>i k
awaitl q
handlerr y
.y z
Handle	z €
(
€ 
request
 ˆ
)
ˆ ‰
)
‰ Š
. 
WithName 
( 
$str !
)! "
;" #
} 
} ¬.
</home/cossi/Code/UniShare/Backend/UniShare/Api/BookingApi.cs
	namespace 	
UniShare
 
. 
Api 
; 
public

 
static

 
class

 

BookingApi

 
{ 
public 

static 
void 
MapBookingEndpoints *
(* +
this+ /!
IEndpointRouteBuilder0 E
appF I
)I J
{ 
app 
. 
MapPost 
( 
$str 
,  
async 
( 
[ 
FromBody  
]  ! 
CreateBookingRequest" 6
request7 >
,> ?
[ 
FromServices %
]% & 
CreateBookingHandler' ;
handler< C
)C D
=>E G
await 
handler !
.! "
Handle" (
(( )
request) 0
)0 1
)1 2
. 
WithName 
( 
$str %
)% &
. 
Accepts 
<  
CreateBookingRequest )
>) *
(* +
$str+ =
)= >
. 
Produces 
( 
$num 
) 
. 
Produces 
( 
$num 
) 
. 
Produces 
( 
$num 
) 
; 
app 
. 
MapGet 
( 
$str 
, 
async 
( 
	IMediator  
mediator! )
)) *
=>+ -
await 
mediator "
." #
Send# '
(' (
new( +
GetAllBookings, :
.: ;
Query; @
(@ A
)A B
)B C
)C D
. 
WithName 
( 
$str &
)& '
;' (
app 
. 
MapPost 
( 
$str 3
,3 4
async 
( 
Guid 
	bookingId %
,% &
[ 
FromBody !
]! "
ApproveBookingBody# 5
body6 :
,: ;
[   
FromServices   %
]  % &!
ApproveBookingHandler  ' <
handler  = D
)  D E
=>  F H
{!! 
var"" 
approveRequest"" &
=""' (
new"") ,!
ApproveBookingRequest""- B
(""B C
	bookingId""C L
,""L M
body""N R
.""R S
Approve""S Z
)""Z [
;""[ \
return## 
await##  
handler##! (
.##( )
Handle##) /
(##/ 0
approveRequest##0 >
)##> ?
;##? @
}$$ 
)$$ 
.%% 
WithName%% 
(%% 
$str%% &
)%%& '
.&& 
Accepts&& 
<&& 
ApproveBookingBody&& '
>&&' (
(&&( )
$str&&) ;
)&&; <
.'' 
Produces'' 
('' 
$num'' 
)'' 
.(( 
Produces(( 
((( 
$num(( 
)(( 
.)) 
Produces)) 
()) 
$num)) 
))) 
.** 
Produces** 
(** 
$num** 
)** 
.++ 
Produces++ 
(++ 
$num++ 
)++ 
;++ 
app-- 
.-- 
MapPost-- 
(-- 
$str-- 2
,--2 3
async.. 
(.. 
Guid.. 
	bookingId.. %
,..% &
[// 
FromServices// %
]//% &!
ApproveBookingHandler//' <
handler//= D
)//D E
=>//F H
{00 
var11 
rejectRequest11 %
=11& '
new11( +!
ApproveBookingRequest11, A
(11A B
	bookingId11B K
,11K L
false11M R
)11R S
;11S T
return22 
await22  
handler22! (
.22( )
Handle22) /
(22/ 0
rejectRequest220 =
)22= >
;22> ?
}33 
)33 
.44 
WithName44 
(44 
$str44 %
)44% &
.55 
Produces55 
(55 
$num55 
)55 
.66 
Produces66 
(66 
$num66 
)66 
.77 
Produces77 
(77 
$num77 
)77 
.88 
Produces88 
(88 
$num88 
)88 
.99 
Produces99 
(99 
$num99 
)99 
;99 
app;; 
.;; 
MapPost;; 
(;; 
$str;; 4
,;;4 5
async<< 
(<< 
Guid<< 
	bookingId<< %
,<<% &
[<<' (
FromServices<<( 4
]<<4 5"
CompleteBookingHandler<<6 L
handler<<M T
)<<T U
=><<V X
await== 
handler== !
.==! "
Handle==" (
(==( )
	bookingId==) 2
)==2 3
)==3 4
.>> 
WithName>> 
(>> 
$str>> '
)>>' (
.?? 
Produces?? 
(?? 
$num?? 
)?? 
.@@ 
Produces@@ 
(@@ 
$num@@ 
)@@ 
.AA 
ProducesAA 
(AA 
$numAA 
)AA 
.BB 
ProducesBB 
(BB 
$numBB 
)BB 
.CC 
ProducesCC 
(CC 
$numCC 
)CC 
;CC 
}DD 
}EE À
;/home/cossi/Code/UniShare/Backend/UniShare/Api/ReviewApi.cs
	namespace 	
UniShare
 
. 
Api 
; 
public 
static 
class 
	ReviewApi 
{		 
public

 

static

 
void

 
MapReviewEndpoints

 )
(

) *
this

* .!
IEndpointRouteBuilder

/ D
app

E H
)

H I
{ 
app 
. 
MapPost 
( 
$str 
, 
async  %
(& '
CreateReviewRequest' :
request; B
,B C
[D E
FromServicesE Q
]Q R
CreateReviewHandlerS f
handlerg n
)n o
=>p r
await 
handler 
. 
Handle  
(  !
request! (
)( )
)) *
. 
WithName 
( 
$str $
)$ %
;% &
app 
. 
MapGet 
( 
$str 
, 
async $
(% &
	IMediator& /
mediator0 8
)8 9
=>: <
await 
mediator 
. 
Send #
(# $
new$ '
GetAllReviews( 5
.5 6
Query6 ;
(; <
)< =
)= >
)> ?
. 
WithName 
( 
$str %
)% &
;& '
} 
} ‡&
9/home/cossi/Code/UniShare/Backend/UniShare/Api/ItemApi.cs
	namespace		 	
UniShare		
 
.		 
Api		 
;		 
public 
static 
class 
ItemApi 
{ 
public 

static 
void 
MapItemEndpoints '
(' (
this( ,!
IEndpointRouteBuilder- B
appC F
)F G
{ 
app 
. 
MapPost 
( 
$str 
, 
async #
($ %
[% &
FromBody& .
]. /
CreateItemRequest0 A
requestB I
,I J
[K L
FromServicesL X
]X Y
CreateItemHandlerZ k
handlerl s
)s t
=>u w
awaitx }
handler	~ …
.
… †
Handle
† Œ
(
Œ 
request
 ”
)
” •
)
• –
. 
WithName 
( 
$str "
)" #
. 
Accepts 
< 
CreateItemRequest &
>& '
(' (
$str( :
): ;
. 
Produces 
( 
$num 
) 
. 
Produces 
( 
$num 
) 
. 
Produces 
( 
$num 
) 
; 
app 
. 
MapGet 
( 
$str 
, 
async "
(# $
	IMediator$ -
mediator. 6
)6 7
=>8 :
await; @
mediatorA I
.I J
SendJ N
(N O
newO R
GetAllItemsS ^
.^ _
Query_ d
(d e
)e f
)f g
)g h
. 
WithName 
( 
$str #
)# $
;$ %
app 
. 
MapGet 
( 
$str  
,  !
async" '
(( )
	IMediator) 2
mediator3 ;
,; < 
IHttpContextAccessor= Q
httpContextAccessorR e
)e f
=>g i
{ 
var 
httpContext 
=  !
httpContextAccessor" 5
.5 6
HttpContext6 A
;A B
if 
( 
httpContext 
is  "
null# '
||( *
!+ ,
httpContext, 7
.7 8
Items8 =
.= >
TryGetValue> I
(I J
$strJ R
,R S
outT W
varX [
	userIdObj\ e
)e f
||g i
	userIdObjj s
ist v
notw z
Guid{ 
userId
€ †
)
† ‡
{ 
return 
Results "
." #
Unauthorized# /
(/ 0
)0 1
;1 2
} 
var!! 
items!! 
=!! 
await!! !
mediator!!" *
.!!* +
Send!!+ /
(!!/ 0
new!!0 3
GetItemsByOwner!!4 C
.!!C D
Query!!D I
(!!I J
userId!!J P
)!!P Q
)!!Q R
;!!R S
return"" 
Results"" 
."" 
Ok"" !
(""! "
items""" '
)""' (
;""( )
}## 
)## 
.$$ 
WithName$$ 
($$ 
$str$$ "
)$$" #
.%% 
Produces%% 
<%% 
IEnumerable%% !
<%%! "
Item%%" &
>%%& '
>%%' (
(%%( )
$num%%) ,
)%%, -
.&& 
Produces&& 
(&& 
$num&& 
)&& 
;&& 
app(( 
.(( 
	MapDelete(( 
((( 
$str(( (
,((( )
async((* /
(((0 1
Guid((1 5
id((6 8
,((8 9
[((: ;
FromServices((; G
]((G H
DeleteItemHandler((I Z
handler(([ b
)((b c
=>((d f
await)) 
handler)) 
.)) 
Handle)) $
())$ %
id))% '
)))' (
)))( )
.** 
WithName** 
(** 
$str** "
)**" #
.++ 
Produces++ 
(++ 
$num++ 
)++ 
.,, 
Produces,, 
(,, 
$num,, 
),, 
.-- 
Produces-- 
(-- 
$num-- 
)-- 
... 
Produces.. 
(.. 
$num.. 
).. 
;.. 
}// 
}00 